<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIXEND</title>
    <!-- Configuration automatique du serveur -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-bg: #0f0f0f;
            --color-bg-secondary: #1a1a2e;
            --color-bg-tertiary: #16213e;
            --color-primary: #ff006e;
            --color-accent: #00d4ff;
            --color-text: #e0e0e0;
            --color-text-dim: #666666;
            --color-border: #2a2a3e;
            --font-pixel: 'Press Start 2P', 'Courier New', monospace;
        }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-pixel);
            font-size: 12px;
            overflow: hidden;
            line-height: 1.5;
            position: relative;
        }

        /* TEXTURE PIXEL RÃ‰TRO & SCANLINES */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(255, 0, 110, 0.03),
                    rgba(255, 0, 110, 0.03) 2px,
                    transparent 2px,
                    transparent 4px
                );
            pointer-events: none;
            z-index: 9999;
        }

        /* PAGE D'ACCUEIL */
        .welcome-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.5s ease-out;
        }

        .welcome-screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .welcome-container {
            text-align: center;
            background-color: var(--color-bg-secondary);
            border: 4px solid var(--color-primary);
            padding: 40px;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.8);
            max-width: 650px;
        }

        .welcome-logo {
            font-size: 28px;
            color: var(--color-accent);
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
            letter-spacing: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { text-shadow: 0 0 20px rgba(0, 212, 255, 0.8); }
            50% { text-shadow: 0 0 40px rgba(0, 212, 255, 1); }
        }

        .welcome-subtitle {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 11px;
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
            letter-spacing: 2px;
        }

        .active-channels-preview {
            background-color: var(--color-bg-tertiary);
            border: 2px solid var(--color-accent);
            padding: 15px;
            margin-bottom: 25px;
            max-height: 120px;
            overflow-y: auto;
            text-align: left;
        }

        .preview-title {
            color: var(--color-accent);
            font-size: 10px;
            margin-bottom: 10px;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }

        .channel-preview-item {
            color: var(--color-text);
            font-size: 9px;
            padding: 5px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .channel-preview-item:last-child {
            border-bottom: none;
        }

        .channel-preview-item::before {
            content: "â–¸ ";
            color: var(--color-primary);
            margin-right: 4px;
        }

        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* FORMULAIRES DANS L'ACCUEIL */
        .welcome-form {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .welcome-form.active {
            display: block;
        }

        .welcome-form .form-group {
            margin-bottom: 12px;
        }

        .welcome-form .form-label {
            display: block;
            color: var(--color-accent);
            font-size: 9px;
            margin-bottom: 4px;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
        }

        .welcome-form .form-input {
            width: 100%;
            padding: 8px;
            background-color: var(--color-bg-tertiary);
            border: 2px solid var(--color-border);
            color: var(--color-text);
            font-family: var(--font-pixel);
            font-size: 10px;
            transition: all 0.1s;
        }

        .welcome-form .form-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        /* TOGGLE Å’EIL POUR MOT DE PASSE */
        .password-field {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-field input {
            flex: 1;
        }

        .password-toggle {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }

        .password-toggle:hover {
            color: var(--color-primary);
            text-shadow: 0 0 8px rgba(255, 0, 110, 0.5);
            transform: scale(1.1);
        }

        .password-toggle:active {
            transform: scale(0.95);
        }

        /* STYLE PIXEL POUR L'Å’IL */
        .eye-pixel {
            font-family: monospace;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* Å’IL PIXELISÃ‰ CSS */
        .pixel-eye {
            display: inline-block;
            width: 16px;
            height: 12px;
            position: relative;
        }

        .pixel-eye::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 8px;
            background-color: var(--color-accent);
            border: 1px solid var(--color-accent);
            left: 3px;
            top: 2px;
            clip-path: polygon(0% 50%, 100% 0%, 100% 100%);
        }

        .pixel-eye::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: var(--color-bg);
            border-radius: 0;
            left: 6px;
            top: 4px;
        }

        .welcome-form-alert {
            padding: 8px;
            margin-bottom: 12px;
            border-left: 3px solid;
            font-size: 8px;
            animation: slideDown 0.3s ease-out;
            min-height: 20px;
        }

        .welcome-form-alert.error {
            background-color: rgba(255, 68, 68, 0.1);
            border-color: #ff4444;
            color: #ff8888;
        }

        .welcome-form-alert.success {
            background-color: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        .form-buttons-welcome {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .btn-form-welcome {
            padding: 10px 20px;
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            border: 2px solid;
            transition: all 0.1s;
            flex: 1;
        }

        .btn-form-welcome.primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-bg);
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .btn-form-welcome.primary:hover {
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
            transform: scale(1.05);
        }

        .btn-form-welcome.secondary {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        .btn-form-welcome.secondary:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .btn-form-welcome:active {
            transform: scale(0.98);
        }

        .back-link {
            text-align: center;
            margin-top: 12px;
            font-size: 9px;
        }

        .back-link a {
            color: var(--color-accent);
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.1s;
        }

        .back-link a:hover {
            color: var(--color-primary);
            text-shadow: 0 0 8px rgba(255, 0, 110, 0.5);
        }

        .btn-welcome {
            padding: 15px 30px;
            font-family: var(--font-pixel);
            font-size: 11px;
            border: 3px solid;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .btn-welcome.primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-bg);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.6);
        }

        .btn-welcome.primary:hover {
            box-shadow: 0 0 25px rgba(255, 0, 110, 0.9);
            transform: scale(1.05);
        }

        .btn-welcome.secondary {
            background-color: transparent;
            border-color: var(--color-accent);
            color: var(--color-accent);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.4);
        }

        .btn-welcome.secondary:hover {
            background-color: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
            transform: scale(1.05);
        }

        .btn-welcome.tertiary {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-border);
            color: var(--color-text);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }

        .btn-welcome.tertiary:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .btn-welcome:active {
            transform: scale(0.98);
        }

        /* CONTAINER PRINCIPAL */
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* PANNEAU GAUCHE - SALONS */
        .sidebar {
            width: 250px;
            background-color: var(--color-bg-secondary);
            border-right: 3px solid var(--color-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: inset -5px 0 15px rgba(0, 0, 0, 0.8);
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 3px solid var(--color-accent);
            background-color: var(--color-bg-tertiary);
            text-align: center;
            color: var(--color-accent);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .sidebar-header h2 {
            font-size: 10px;
            letter-spacing: 2px;
        }

        .channels-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .channel-item {
            padding: 8px 12px;
            margin: 4px 0;
            background-color: var(--color-bg);
            border: 2px solid var(--color-border);
            cursor: pointer;
            transition: all 0.1s;
            font-size: 11px;
            text-align: left;
            position: relative;
        }

        .channel-item:hover {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .channel-item.active {
            background-color: var(--color-primary);
            color: var(--color-bg);
            border-color: var(--color-primary);
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.7);
        }

        .channel-item::before {
            content: "#";
            margin-right: 4px;
            color: var(--color-accent);
        }

        .channel-item.private::before {
            content: "ðŸ’¬";
            margin-right: 4px;
        }

        .new-channel-btn {
            padding: 8px 12px;
            margin: 8px;
            background-color: var(--color-primary);
            border: 2px solid var(--color-primary);
            color: var(--color-bg);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            transition: all 0.1s;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .new-channel-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
        }

        .new-channel-btn:active {
            transform: scale(0.98);
        }

        /* PANNEAU PRINCIPAL */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg);
        }

        .header {
            background-color: var(--color-bg-secondary);
            border-bottom: 3px solid var(--color-primary);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
        }

        .channel-name {
            color: var(--color-accent);
            font-size: 13px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border: 2px solid var(--color-primary);
            background-color: var(--color-bg-tertiary);
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-status {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-auth {
            padding: 6px 12px;
            background-color: var(--color-accent);
            color: var(--color-bg);
            border: 2px solid var(--color-accent);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 9px;
            transition: all 0.1s;
        }

        .btn-auth:hover {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(255, 0, 110, 0.5);
        }

        .btn-logout {
            padding: 6px 12px;
            background-color: var(--color-border);
            color: var(--color-text);
            border: 2px solid var(--color-border);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 9px;
            transition: all 0.1s;
        }

        .btn-logout:hover {
            background-color: #ff4444;
            border-color: #ff4444;
        }

        .btn-home {
            padding: 6px 12px;
            background-color: var(--color-bg-tertiary);
            border: 2px solid var(--color-border);
            color: var(--color-text);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 9px;
            transition: all 0.1s;
        }

        .btn-home:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        /* ZONE CHAT */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 3px solid var(--color-border);
            margin: 8px;
            background-color: var(--color-bg-tertiary);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.6);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .typing-indicator {
            display: none;
            padding: 8px 12px;
            color: var(--color-accent);
            font-size: 10px;
            font-style: italic;
            animation: blink 1.5s infinite;
        }

        .typing-indicator.active {
            display: block;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .message {
            display: flex;
            gap: 8px;
            padding: 8px;
            background-color: var(--color-bg);
            border-left: 3px solid var(--color-accent);
            word-break: break-word;
            animation: messageSlideIn 0.2s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 1px solid var(--color-primary);
            background-color: var(--color-bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
            border-radius: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .message-author {
            color: var(--color-primary);
            font-weight: bold;
            font-size: 10px;
            text-shadow: 0 0 5px rgba(255, 0, 110, 0.5);
        }

        .message-time {
            color: var(--color-text-dim);
            font-size: 8px;
        }

        .message-text {
            color: var(--color-text);
            font-size: 11px;
            word-wrap: break-word;
        }

        /* INPUT ZONE */
        .input-area {
            padding: 12px;
            background-color: var(--color-bg-secondary);
            border-top: 3px solid var(--color-border);
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .message-input-wrapper {
            flex: 1;
            display: flex;
            gap: 6px;
            align-items: flex-end;
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 8px;
            background-color: var(--color-bg);
            border: 2px solid var(--color-border);
            color: var(--color-text);
            font-family: var(--font-pixel);
            font-size: 11px;
            transition: all 0.1s;
            height: 34px;
            min-width: 200px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .send-btn {
            padding: 8px 16px;
            background-color: var(--color-primary);
            border: 2px solid var(--color-primary);
            color: var(--color-bg);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 11px;
            font-weight: bold;
            transition: all 0.1s;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
            min-width: 80px;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
        }

        .send-btn:active {
            transform: scale(0.98);
        }

        /* MODALE DE DIALOGUE */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-bg-secondary);
            border: 3px solid var(--color-primary);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.8);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            color: var(--color-accent);
            font-size: 13px;
            margin-bottom: 16px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            text-align: center;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            color: var(--color-text);
            font-size: 10px;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            background-color: var(--color-bg);
            border: 2px solid var(--color-border);
            color: var(--color-text);
            font-family: var(--font-pixel);
            font-size: 11px;
            transition: all 0.1s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .form-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
        }

        .btn-modal {
            padding: 8px 16px;
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            border: 2px solid;
            transition: all 0.1s;
            min-width: 80px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-bg);
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
            transform: scale(1.05);
        }

        .btn-secondary {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        /* SCROLLBAR PERSONNALISÃ‰E */
        .messages-container::-webkit-scrollbar,
        .channels-list::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track,
        .channels-list::-webkit-scrollbar-track {
            background: var(--color-bg-tertiary);
        }

        .messages-container::-webkit-scrollbar-thumb,
        .channels-list::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 2px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover,
        .channels-list::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .btn-file {
            padding: 8px 12px;
            background-color: var(--color-accent);
            border: 2px solid var(--color-accent);
            color: var(--color-bg);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            transition: all 0.1s;
        }

        .btn-file:hover {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        /* BOUTONS GOOGLE & SOCIAL */
        .btn-google {
            width: 100%;
            padding: 10px;
            background-color: #ffffff;
            border: 2px solid #4285f4;
            color: #000;
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            transition: all 0.1s;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-google:hover {
            background-color: #f1f1f1;
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: var(--color-text-dim);
            font-size: 9px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: var(--color-border);
        }

        .divider::before {
            margin-right: 8px;
        }

        .divider::after {
            margin-left: 8px;
        }

        .alert {
            padding: 10px;
            margin-bottom: 12px;
            border-left: 3px solid;
            font-size: 9px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.error {
            background-color: rgba(255, 68, 68, 0.1);
            border-color: #ff4444;
            color: #ff8888;
        }

        .alert.success {
            background-color: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        /* PROFIL UTILISATEUR MODAL */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-modal-content {
            background-color: var(--color-bg-secondary);
            border: 3px solid var(--color-accent);
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 4px;
            border: 2px solid var(--color-primary);
        }

        .profile-info {
            flex: 1;
        }

        .profile-username {
            color: var(--color-accent);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .profile-user-id {
            color: var(--color-text-dim);
            font-size: 8px;
        }

        .profile-section {
            margin-bottom: 15px;
        }

        .profile-section-title {
            color: var(--color-primary);
            font-size: 10px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .profile-field-label {
            color: var(--color-text-dim);
            font-size: 8px;
        }

        .profile-field-value {
            color: var(--color-text);
            font-size: 10px;
            padding: 6px 8px;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
        }

        .profile-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-profile {
            flex: 1;
            padding: 8px;
            background-color: var(--color-accent);
            border: 2px solid var(--color-accent);
            color: var(--color-bg);
            font-family: var(--font-pixel);
            font-size: 9px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn-profile:hover {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-profile-logout {
            background-color: #ff4444;
            border-color: #ff4444;
        }

        .btn-profile-logout:hover {
            background-color: #ff6666;
            border-color: #ff6666;
        }

        .close-profile-btn {
            float: right;
            color: var(--color-accent);
            cursor: pointer;
            font-size: 16px;
            margin: -10px -10px 0 0;
        }

        .close-profile-btn:hover {
            color: var(--color-primary);
        }

        /* MENU DU SALON */
        .channel-menu {
            position: fixed;
            right: 0;
            top: 50px;
            width: 300px;
            max-height: 600px;
            background-color: var(--color-bg-secondary);
            border-left: 3px solid var(--color-accent);
            border-bottom: 3px solid var(--color-accent);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 900;
        }

        .channel-menu.open {
            transform: translateX(0);
        }

        .channel-menu-header {
            padding: 12px;
            border-bottom: 2px solid var(--color-border);
            background-color: var(--color-bg);
        }

        .channel-menu-title {
            color: var(--color-accent);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .channel-info {
            font-size: 9px;
            color: var(--color-text-dim);
        }

        .channel-menu-section {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .channel-menu-label {
            color: var(--color-primary);
            font-size: 9px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            color: var(--color-text);
            font-size: 9px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background-color: #00ff00;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .online-count {
            color: var(--color-accent);
            font-weight: bold;
        }

        /* EMOJI PICKER */
        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 35px;
            left: 0;
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-accent);
            padding: 8px;
            border-radius: 4px;
            width: 280px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 800;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.1s;
        }

        .emoji-item:hover {
            background-color: var(--color-accent);
            transform: scale(1.2);
        }

        .btn-emoji {
            padding: 8px 10px;
            background-color: var(--color-bg);
            border: 2px solid var(--color-border);
            color: var(--color-accent);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.1s;
            position: relative;
            flex-shrink: 0;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-emoji:hover {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-primary);
        }

        .btn-emoji.active {
            background-color: var(--color-accent);
            color: var(--color-bg);
        }

        /* BOUTTON MENU SALON DANS LE HEADER */
        .btn-channel-menu {
            padding: 6px 8px;
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-accent);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.1s;
        }

        .btn-channel-menu:hover {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-primary);
        }

        .btn-channel-menu.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-bg);
        }

        /* ===== PIXEND V2 STYLES ===== */
        
        /* SERVERS */
        .sidebar-section {
            margin: 8px 0;
            padding: 4px 0;
            border-top: 2px solid var(--color-border);
        }

        .server-container {
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: 2px;
            margin: 8px 4px;
            padding: 8px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        }

        .server-header {
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--color-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .server-actions {
            display: flex;
            gap: 4px;
        }

        .channel-item {
            padding: 4px 8px;
            margin: 2px 0;
            background-color: rgba(0, 212, 255, 0.1);
            border-left: 3px solid var(--color-accent);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-item:hover {
            background-color: rgba(0, 212, 255, 0.2);
        }

        .channel-item.active {
            background-color: rgba(255, 0, 110, 0.3);
            border-left-color: var(--color-primary);
        }

        /* RANK BADGES */
        .rank-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            margin-left: 4px;
            text-transform: uppercase;
            border: 1px solid currentColor;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        }

        .rank-badge.user {
            background-color: #808080;
            color: #ffffff;
            box-shadow: 0 0 8px rgba(128, 128, 128, 0.5);
        }

        .rank-badge.guardian {
            background-color: #ff0000;
            color: #ffffff;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
        }

        .rank-badge.admin {
            background-color: #0080ff;
            color: #ffffff;
            box-shadow: 0 0 8px rgba(0, 128, 255, 0.6);
        }

        /* PROFILE PAGE */
        .profile-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            overflow-y: auto;
            z-index: 1500;
        }

        .profile-page.active {
            display: block;
        }

        .profile-container {
            max-width: 800px;
            margin: 20px auto;
            background-color: var(--color-bg-secondary);
            border: 4px solid var(--color-primary);
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-accent);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border: 3px solid var(--color-accent);
            image-rendering: pixelated;
        }

        .profile-info {
            flex: 1;
        }

        .profile-username {
            font-size: 18px;
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .profile-status {
            color: var(--color-text-dim);
            font-size: 10px;
        }

        .profile-section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: rgba(0, 212, 255, 0.1);
            border-left: 3px solid var(--color-accent);
        }

        .profile-section-title {
            color: var(--color-accent);
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 10px;
        }

        .profile-section-content {
            color: var(--color-text);
            font-size: 10px;
            line-height: 1.4;
        }

        .profile-servers-list,
        .profile-friends-list,
        .profile-ranks-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .profile-server-item,
        .profile-friend-item,
        .profile-rank-item {
            padding: 6px 8px;
            background-color: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-close-btn {
            display: block;
            margin-top: 20px;
            width: 100%;
        }

        /* MODALS V2 */
        .modal-server-settings {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-bg-secondary);
            border: 4px solid var(--color-primary);
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1600;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
        }

        .modal-server-settings.active {
            display: block;
        }

        .modal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }

        .modal-tab {
            padding: 8px 12px;
            background-color: transparent;
            border: none;
            color: var(--color-text-dim);
            cursor: pointer;
            text-transform: uppercase;
            font-size: 9px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .modal-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .dm-item {
            padding: 8px;
            margin: 4px 0;
            background-color: rgba(0, 212, 255, 0.1);
            border-left: 3px solid var(--color-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dm-item:hover {
            background-color: rgba(0, 212, 255, 0.2);
        }

        .dm-item.active {
            background-color: rgba(255, 0, 110, 0.3);
            border-left-color: var(--color-primary);
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #00ff00;
            box-shadow: 0 0 4px #00ff00;
            display: inline-block;
        }

        .online-indicator.offline {
            background-color: #666666;
            box-shadow: none;
        }

        .join-request-item {
            padding: 12px;
            background-color: var(--color-bg-tertiary);
            border: 2px solid var(--color-accent);
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 2px;
        }

        .join-request-info {
            flex: 1;
        }

        .join-request-actions {
            display: flex;
            gap: 8px;
        }

        .join-request-actions button {
            padding: 4px 12px;
            font-size: 9px;
        }

        #newServerModal {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #newServerModal.active,
        #newServerModal[style*="display: flex"] {
            display: flex !important;
        }

        /* ===== PAGE DE PROFIL COMPLÃˆTE ===== */
        .profile-page, .other-profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            z-index: 1800;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .profile-page.active, .other-profile-page.active {
            display: flex !important;
        }

        .profile-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 2px solid var(--color-border);
            background-color: var(--color-bg-secondary);
        }

        .profile-page-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            font-size: 12px;
            padding: 8px;
        }

        .btn-back:hover {
            color: var(--color-primary);
        }

        .profile-page-content {
            flex: 1;
            display: flex;
            gap: 24px;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--color-bg);
        }

        .profile-left {
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .profile-avatar-section {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .profile-page-avatar {
            width: 120px;
            height: 120px;
            border: 3px solid var(--color-primary);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.5);
            image-rendering: pixelated;
        }

        .profile-user-info {
            text-align: center;
        }

        .profile-username-edit {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .profile-username-input {
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-accent);
            color: var(--color-text);
            padding: 8px;
            font-family: var(--font-pixel);
            font-size: 12px;
            width: 200px;
        }

        .profile-username-display {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-text);
        }

        .profile-user-id {
            font-size: 10px;
            color: var(--color-text-dim);
            margin-top: 4px;
        }

        .profile-join-date {
            font-size: 9px;
            color: var(--color-text-dim);
            margin-top: 4px;
        }

        .profile-section {
            padding: 16px;
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: 2px;
        }

        .profile-section-title {
            font-size: 11px;
            font-weight: bold;
            color: var(--color-accent);
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }

        .profile-ranks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-rank-item {
            padding: 8px 12px;
            background-color: var(--color-bg);
            border-left: 3px solid var(--color-accent);
            font-size: 10px;
        }

        .profile-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: 16px;
        }

        .profile-tab {
            padding: 8px 16px;
            background-color: transparent;
            border: none;
            color: var(--color-text-dim);
            cursor: pointer;
            font-size: 10px;
            font-family: var(--font-pixel);
            text-transform: uppercase;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .profile-tab:hover {
            color: var(--color-text);
        }

        .profile-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .profile-tab-content {
            display: none;
        }

        .profile-tab-content.active {
            display: block;
        }

        .profile-favorites-list, .profile-friends-list, .profile-servers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-favorite-item, .profile-friend-item, .profile-server-item {
            padding: 12px;
            background-color: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .profile-favorite-item:hover, .profile-friend-item:hover, .profile-server-item:hover {
            background-color: var(--color-bg-secondary);
            border-color: var(--color-primary);
        }

        .profile-item-info {
            flex: 1;
        }

        .profile-item-name {
            font-size: 11px;
            font-weight: bold;
            color: var(--color-text);
        }

        .profile-item-status {
            font-size: 9px;
            color: var(--color-text-dim);
            margin-top: 2px;
        }

        .profile-item-actions {
            display: flex;
            gap: 4px;
        }

        .btn-profile-item {
            padding: 4px 8px;
            background-color: var(--color-primary);
            border: none;
            color: var(--color-bg);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 8px;
            border-radius: 2px;
        }

        .btn-profile-item:hover {
            background-color: var(--color-accent);
        }

        .btn-change-avatar, .btn-edit-username {
            background-color: var(--color-accent);
            border: none;
            color: var(--color-bg);
            cursor: pointer;
            padding: 6px 12px;
            font-family: var(--font-pixel);
            font-size: 9px;
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            padding: 16px;
            background-color: var(--color-bg-secondary);
            border-top: 2px solid var(--color-border);
            justify-content: center;
        }

        .btn-profile-action {
            padding: 8px 20px;
            background-color: var(--color-primary);
            border: none;
            color: var(--color-bg);
            cursor: pointer;
            font-family: var(--font-pixel);
            font-size: 10px;
            transition: all 0.2s;
        }

        .btn-profile-action:hover {
            background-color: var(--color-accent);
        }

        .btn-profile-action.secondary {
            background-color: var(--color-accent);
        }

        .profile-other-actions {
            display: flex;
            gap: 12px;
        }

        .online-indicator-small {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

    </style>
</head>
<body>
    <!-- Google Sign-In Script -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- PAGE D'ACCUEIL -->
    <div class="welcome-screen active" id="welcomeScreen">
        <div class="welcome-container">
            <div class="welcome-logo">â¬› PIXEND â¬›</div>
            <div class="welcome-subtitle">created by Lost_hope</div>
            <div class="welcome-subtitle">send your pixels</div>
            <div class="welcome-subtitle">ce site n'es pas encore terminÃ©, vous experimentez une version bÃ©ta. il est donc possible de rencontrer des problemes.</div>

            <div class="active-channels-preview">
                <div class="preview-title">SALONS ACTIFS</div>
                <div id="previewChannels"></div>
            </div>

            <!-- VUE PRINCIPALE -->
            <div id="welcomeMainView" class="welcome-form active">
                <div class="welcome-buttons">
                    <button class="btn-welcome primary" id="continueAnonBtn">CONTINUER ANONYME</button>
                    <button class="btn-welcome secondary" id="showLoginBtn">SE CONNECTER</button>
                    <button class="btn-welcome secondary" id="showRegisterBtn">S'INSCRIRE</button>
                </div>
            </div>

            <!-- VUE CONNEXION -->
            <div id="welcomeLoginView" class="welcome-form">
                <div id="loginWelcomeAlert" class="welcome-form-alert"></div>
                <form autocomplete="on">
                <div class="form-group">
                    <label class="form-label">EMAIL</label>
                    <input type="email" class="form-input" id="welcomeLoginEmail" placeholder="votre@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label">MOT DE PASSE</label>
                    <div class="password-field">
                        <input type="password" class="form-input" id="welcomeLoginPassword" placeholder="Votre mot de passe" style="padding-right: 40px;" autocomplete="current-password">
                        <button type="button" class="password-toggle eye-pixel" id="welcomeLoginToggle" data-target="welcomeLoginPassword">ðŸ‘ï¸</button>
                    </div>
                </div>
                <div class="form-buttons-welcome">
                    <button type="submit" class="btn-form-welcome primary" id="welcomeLoginSubmitBtn">CONNEXION</button>
                    <button type="button" class="btn-form-welcome secondary" id="welcomeLoginBackBtn">RETOUR</button>
                </div>
                </form>
            </div>

            <!-- VUE INSCRIPTION -->
            <div id="welcomeRegisterView" class="welcome-form">
                <div id="registerWelcomeAlert" class="welcome-form-alert"></div>
                <div class="form-group">
                    <label class="form-label">PSEUDO</label>
                    <input type="text" class="form-input" id="welcomeRegisterUsername" placeholder="Votre pseudo" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">EMAIL</label>
                    <input type="email" class="form-input" id="welcomeRegisterEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">MOT DE PASSE</label>
                    <div class="password-field">
                        <input type="password" class="form-input" id="welcomeRegisterPassword" placeholder="Min. 6 caractÃ¨res" style="padding-right: 40px;">
                        <button type="button" class="password-toggle eye-pixel" id="welcomeRegisterToggle" data-target="welcomeRegisterPassword">ðŸ‘ï¸</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">CONFIRMER MOT DE PASSE</label>
                    <div class="password-field">
                        <input type="password" class="form-input" id="welcomeRegisterPasswordConfirm" placeholder="Confirmez le mot de passe" style="padding-right: 40px;">
                        <button type="button" class="password-toggle eye-pixel" id="welcomeRegisterConfirmToggle" data-target="welcomeRegisterPasswordConfirm">ðŸ‘ï¸</button>
                    </div>
                </div>
                <div class="form-buttons-welcome">
                    <button class="btn-form-welcome primary" id="welcomeRegisterSubmitBtn">INSCRIRE</button>
                    <button class="btn-form-welcome secondary" id="welcomeRegisterBackBtn">RETOUR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INTERFACE PRINCIPALE -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- PANNEAU GAUCHE - SALONS -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>PIXEND</h2>
            </div>
            
            <div class="channels-list" id="channelsList">
                <!-- Les salons seront ajoutÃ©s ici via JavaScript -->
            </div>

            <button class="new-channel-btn" id="newServerBtn" onclick="openNewServerModal()" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent)); margin-bottom: 8px;">ðŸ“¦ NOUVEAU SERVEUR</button>
            <button class="new-channel-btn" id="newChannelBtn">+ NOUVEAU SALON</button>
        </div>

        <!-- PANNEAU PRINCIPAL -->
        <div class="main-panel">
            <!-- EN-TÃŠTE -->
            <div class="header">
                <div class="channel-name" id="channelName">SÃ©lectionnez un salon</div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">ðŸ‘¤</div>
                    <div class="user-status">
                        <span id="userName">Anonyme #1234</span>
                        <span style="color: var(--color-accent); font-size: 9px;" id="userStatus">En ligne</span>
                    </div>
                    <div class="auth-buttons">
                        <button class="btn-channel-menu" id="channelMenuBtn" onclick="toggleChannelMenu()" style="display: none;">ðŸ“Š</button>
                        <button class="btn-home" id="profileBtn" onclick="openProfilePage()" style="display: none;">ðŸ‘¤</button>
                        <button class="btn-home" id="homeBtn">ðŸ </button>
                        <button class="btn-logout" id="logoutBtn" style="display: none;">DÃ‰CONNEXION</button>
                    </div>
                </div>
            </div>

            <!-- ZONE CHAT -->
            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">
                        Bienvenue sur Pixend!<br>SÃ©lectionnez un salon pour commencer Ã  discuter...
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator"></div>

                <!-- INPUT -->
                <div class="input-area">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageUpload" accept="image/*">
                        <button class="btn-file" id="uploadImageBtn">ðŸ“¸</button>
                    </div>
                    <div class="message-input-wrapper">
                        <div style="position: relative; flex-shrink: 0;">
                            <button class="btn-emoji" id="emojiPickerBtn">ðŸ˜€</button>
                            <div class="emoji-picker" id="emojiPicker"></div>
                        </div>
                        <input type="text" class="message-input" id="messageInput" placeholder="Ã‰crivez votre message...">
                    </div>
                    <button class="send-btn" id="sendBtn">ENVOYER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MENU DU SALON -->
    <div class="channel-menu" id="channelMenu">
        <div class="channel-menu-header">
            <div class="close-profile-btn" onclick="closeChannelMenu()">âœ•</div>
            <div class="channel-menu-title" id="menuChannelName">GENERAL</div>
            <div class="channel-info" id="menuChannelInfo">CrÃ©Ã© par systÃ¨me</div>
        </div>
        <div class="channel-menu-section">
            <div class="channel-menu-label">Utilisateurs en ligne</div>
            <div id="onlineUsersList"></div>
        </div>
    </div>

    <!-- MODALE PROFIL UTILISATEUR -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <div class="close-profile-btn" onclick="closeProfileModal()">âœ•</div>
            <div class="profile-header">
                <img id="profileAvatar" class="profile-avatar" src="">
                <div class="profile-info">
                    <div class="profile-username" id="profileUsername">Utilisateur</div>
                    <div class="profile-user-id" id="profileUserId">#0000</div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">Informations</div>
                <div class="profile-field">
                    <div class="profile-field-label">Pseudo</div>
                    <div class="profile-field-value" id="profileDisplayName">Utilisateur</div>
                </div>
                <div class="profile-field">
                    <div class="profile-field-label">RejoignÃ© le</div>
                    <div class="profile-field-value" id="profileJoinDate">Aujourd'hui</div>
                </div>
            </div>

            <div class="profile-section" id="emailSection" style="display: none;">
                <div class="profile-section-title">Email</div>
                <div class="profile-field-value" id="profileEmail"></div>
            </div>

            <div class="profile-buttons">
                <button class="btn-profile" id="editProfileBtn" onclick="editProfile()">MODIFIER</button>
                <button class="btn-profile btn-profile-logout" id="logoutProfileBtn" onclick="logoutProfile()">DÃ‰CONNEXION</button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- MODALE DE CONNEXION -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 class="modal-title">SE CONNECTER</h2>
            <div id="loginAlert"></div>
            
            <button class="btn-google" id="googleLoginBtn">
                <span>ðŸ”µ GOOGLE</span>
            </button>

            <div class="divider">OU</div>

            <form autocomplete="on">
            <div class="form-group">
                <label class="form-label">EMAIL</label>
                <input type="email" class="form-input" id="loginEmail" placeholder="votre@email.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label class="form-label">MOT DE PASSE</label>
                <div class="password-field">
                    <input type="password" class="form-input" id="loginPassword" placeholder="Votre mot de passe" style="padding-right: 40px;" autocomplete="current-password">
                    <button type="button" class="password-toggle eye-pixel" id="loginToggle" data-target="loginPassword">ðŸ‘ï¸</button>
                </div>
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="rememberMeCheckbox" style="width: 16px; height: 16px; cursor: pointer;">
                <label style="margin: 0; cursor: pointer; font-size: 10px;">Afficher le mot de passe</label>
            </div>
            <div class="form-buttons">
                <button type="submit" class="btn-modal btn-primary" id="loginSubmitBtn">CONNEXION</button>
                <button type="button" class="btn-modal btn-secondary" id="loginCancelBtn">ANNULER</button>
            </div>
            </form>
        </div>
    </div>

    <!-- MODALE D'INSCRIPTION -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title">S'INSCRIRE</h2>
            <div id="registerAlert"></div>

            <button class="btn-google" id="googleRegisterBtn">
                <span>ðŸ”µ GOOGLE</span>
            </button>

            <div class="divider">OU</div>

            <div class="form-group">
                <label class="form-label">PSEUDO</label>
                <input type="text" class="form-input" id="registerUsername" placeholder="Votre pseudo" maxlength="20">
            </div>
            <div class="form-group">
                <label class="form-label">EMAIL</label>
                <input type="email" class="form-input" id="registerEmail" placeholder="votre@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">MOT DE PASSE</label>
                <div class="password-field">
                    <input type="password" class="form-input" id="registerPassword" placeholder="Min. 6 caractÃ¨res" style="padding-right: 40px;">
                    <button type="button" class="password-toggle eye-pixel" id="registerToggle" data-target="registerPassword">ðŸ‘ï¸</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">CONFIRMER MOT DE PASSE</label>
                <div class="password-field">
                    <input type="password" class="form-input" id="registerPasswordConfirm" placeholder="Confirmez le mot de passe" style="padding-right: 40px;">
                    <button type="button" class="password-toggle eye-pixel" id="registerConfirmToggle" data-target="registerPasswordConfirm">ðŸ‘ï¸</button>
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-modal btn-primary" id="registerSubmitBtn">INSCRIRE</button>
                <button class="btn-modal btn-secondary" id="registerCancelBtn">ANNULER</button>
            </div>
        </div>
    </div>

    <!-- MODALE DE CRÃ‰ATION DE SALON -->
    <div class="modal" id="newChannelModal">
        <div class="modal-content">
            <h2 class="modal-title">NOUVEAU SALON</h2>
            <div class="form-group">
                <label class="form-label">NOM DU SALON</label>
                <input type="text" class="form-input" id="channelNameInput" placeholder="Ex: gÃ©nÃ©ral, gaming, etc...">
            </div>
            <div class="form-group">
                <label class="form-label">DESCRIPTION</label>
                <input type="text" class="form-input" id="channelDescInput" placeholder="Optionnel">
            </div>
            <div class="form-buttons">
                <button class="btn-modal btn-primary" id="createChannelBtn">CRÃ‰ER</button>
                <button class="btn-modal btn-secondary" id="cancelChannelBtn">ANNULER</button>
            </div>
        </div>
    </div>

    <!-- ===== MODALES V2 ===== -->
    <!-- MODALE NOUVEAU SERVEUR -->
    <div class="modal" id="newServerModal" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">ðŸ“¦ NOUVEAU SERVEUR</h2>
            <div class="form-group">
                <label class="form-label">NOM DU SERVEUR</label>
                <input type="text" class="form-input" id="serverNameInput" placeholder="Ex: Gaming, Amis, etc...">
            </div>
            <div class="form-group">
                <label class="form-label">DESCRIPTION</label>
                <input type="text" class="form-input" id="serverDescInput" placeholder="Qu'est-ce que votre serveur?">
            </div>
            <div class="form-group">
                <label class="form-label">RÃˆGLES DU SERVEUR (OBLIGATOIRE)</label>
                <textarea class="form-input" id="serverRulesInput" placeholder="DÃ©finissez les rÃ¨gles principales..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="serverPublicToggle" checked>
                    <span style="margin-left: 8px;">Serveur PUBLIC (visible Ã  tous)</span>
                </label>
            </div>
            <div class="form-buttons">
                <button class="btn-modal btn-primary" id="createServerBtn">CRÃ‰ER SERVEUR</button>
                <button class="btn-modal btn-secondary" id="cancelServerBtn">ANNULER</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ===== GESTION DE L'Ã‰TAT DE L'APPLICATION =====
        const APP_STATE = {
            user: null,
            isLoggedIn: false,
            users: JSON.parse(localStorage.getItem('pixendUsers')) || {},
            onlineUsers: [],
            activeChannelUsers: {},
            
            // ANCIEN SYSTÃˆME (salons globaux)
            channels: {
                general: {
                    name: 'gÃ©nÃ©ral',
                    description: 'Canal principal',
                    messages: [],
                    createdBy: 'system',
                    isPrivate: false,
                    typing: []
                },
                off_topic: {
                    name: 'off-topic',
                    description: 'Discussions libres',
                    messages: [],
                    createdBy: 'system',
                    isPrivate: false,
                    typing: []
                },
                gaming: {
                    name: 'gaming',
                    description: 'Pour les gamers',
                    messages: [],
                    createdBy: 'system',
                    isPrivate: false,
                    typing: []
                }
            },
            privateChats: {},
            currentChannel: 'general',
            typingTimeout: null,
            
            // NOUVEAU SYSTÃˆME (serveurs avec salons)
            servers: {},
            currentServerId: null,
            currentChannelId: null,
            
            // Friends & Blocks
            friends: {},
            blocked: [],
            
            // DMs
            directMessages: {},
            currentDMUserId: null,
            
            // Moderation
            bans: {},
            warnings: {},
            joinRequests: {},
            
            // Presence
            userPresence: {}
        };

        // ===== DISCORD-LIKE FEATURES: RANKS & ROLES =====
        const RANKS = {
            owner: { 
                name: 'PropriÃ©taire', 
                color: '#ff006e', 
                symbol: 'ðŸ‘‘',
                permissions: ['manage_server', 'manage_channels', 'manage_roles', 'ban_user', 'mute_user', 'delete_message']
            },
            admin: { 
                name: 'Administrateur', 
                color: '#ff0080', 
                symbol: 'âš”ï¸',
                permissions: ['manage_channels', 'ban_user', 'mute_user', 'delete_message']
            },
            moderator: { 
                name: 'ModÃ©rateur', 
                color: '#00d4ff', 
                symbol: 'ðŸ›¡ï¸',
                permissions: ['delete_message', 'mute_user', 'warn_user']
            },
            member: { 
                name: 'Membre', 
                color: '#e0e0e0', 
                symbol: 'ðŸ‘¤',
                permissions: ['send_message', 'read_message']
            },
            muted: { 
                name: 'Muet', 
                color: '#666666', 
                symbol: 'ðŸ”‡',
                permissions: ['read_message']
            }
        };

        // ===== SYNCHRONISATION TEMPS RÃ‰EL =====
        let syncInterval = null;

        function startRealTimeSync() {
            // VÃ©rifier les mises Ã  jour toutes les 500ms
            syncInterval = setInterval(() => {
                syncAppState();
            }, 500);
        }

        function syncAppState() {
            try {
                const saved = localStorage.getItem('pixendAppState');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    // Fusionner les serveurs et leurs messages
                    if (loaded.servers) {
                        Object.keys(loaded.servers).forEach(serverId => {
                            if (!APP_STATE.servers[serverId]) {
                                APP_STATE.servers[serverId] = loaded.servers[serverId];
                            } else {
                                // Fusionner les canaux
                                Object.keys(loaded.servers[serverId].channels || {}).forEach(channelId => {
                                    if (!APP_STATE.servers[serverId].channels[channelId]) {
                                        APP_STATE.servers[serverId].channels[channelId] = loaded.servers[serverId].channels[channelId];
                                    } else {
                                        // VÃ©rifier les nouveaux messages
                                        const newMessages = loaded.servers[serverId].channels[channelId].messages || [];
                                        const currentMessages = APP_STATE.servers[serverId].channels[channelId].messages || [];
                                        
                                        if (newMessages.length > currentMessages.length) {
                                            // Ajouter les nouveaux messages
                                            APP_STATE.servers[serverId].channels[channelId].messages = newMessages;
                                            
                                            // Re-rendre si c'est le canal actuel
                                            if (APP_STATE.currentChannelId === channelId && APP_STATE.currentServerId === serverId) {
                                                renderChatArea();
                                            }
                                        }
                                    }
                                });
                                
                                // Mettre Ã  jour les membres en ligne
                                if (loaded.servers[serverId].onlineMembers) {
                                    APP_STATE.servers[serverId].onlineMembers = loaded.servers[serverId].onlineMembers;
                                    renderOnlineUsers();
                                }
                            }
                        });
                    }
                    
                    // Synchroniser les utilisateurs
                    if (loaded.users) {
                        APP_STATE.users = loaded.users;
                    }
                    
                    // Synchroniser les utilisateurs en ligne
                    if (loaded.onlineUsers) {
                        APP_STATE.onlineUsers = loaded.onlineUsers;
                    }
                }
            } catch(e) {
                console.error('Erreur synchronisation:', e);
            }
        }

        // ===== GESTION DE LA PRÃ‰SENCE EN LIGNE =====
        function updateUserPresence(userId, serverId, channelId, status = 'online') {
            if (!APP_STATE.servers[serverId]) {
                APP_STATE.servers[serverId] = { onlineMembers: {} };
            }
            
            if (!APP_STATE.servers[serverId].onlineMembers) {
                APP_STATE.servers[serverId].onlineMembers = {};
            }
            
            APP_STATE.servers[serverId].onlineMembers[userId] = {
                status: status,
                currentChannel: channelId,
                lastSeen: new Date().toISOString()
            };
            
            saveAppState();
        }

        function renderOnlineUsers() {
            const onlineList = document.getElementById('onlineUsersList');
            if (!onlineList) return;
            
            onlineList.innerHTML = '';
            
            const server = APP_STATE.servers[APP_STATE.currentServerId];
            if (!server || !server.onlineMembers) {
                onlineList.innerHTML = '<div style="color: var(--color-text-dim); padding: 8px;">Aucun utilisateur en ligne</div>';
                return;
            }
            
            const onlineUsers = Object.entries(server.onlineMembers).filter(([_, data]) => data.status === 'online');
            
            if (onlineUsers.length === 0) {
                onlineList.innerHTML = '<div style="color: var(--color-text-dim); padding: 8px;">Aucun utilisateur en ligne</div>';
                return;
            }
            
            onlineUsers.forEach(([userId, data]) => {
                const user = APP_STATE.users[userId];
                if (!user) return;
                
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'padding: 8px; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 8px;';
                
                // Avatar
                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = 'width: 24px; height: 24px; background: var(--color-border); border-radius: 0; overflow: hidden;';
                if (user.avatar) {
                    const img = document.createElement('img');
                    img.src = user.avatar;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                    avatarDiv.appendChild(img);
                }
                userDiv.appendChild(avatarDiv);
                
                // Nom + statut
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'flex: 1;';
                infoDiv.innerHTML = `<div style="color: var(--color-text); font-size: 10px;">${user.displayName}</div><div style="color: var(--color-accent); font-size: 8px;">ðŸŸ¢ En ligne</div>`;
                userDiv.appendChild(infoDiv);
                
                onlineList.appendChild(userDiv);
            });
        }

        // ===== GESTION DU PROFIL =====
        function changeAvatar() {
            const input = document.getElementById('avatarUpload');
            if (input) {
                input.click();
            }
        }

        function setupAvatarUpload() {
            const avatarUpload = document.getElementById('avatarUpload');
            if (!avatarUpload) return;
            
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    // Sauvegarder l'avatar en base64
                    APP_STATE.user.avatar = event.target.result;
                    
                    // Mettre Ã  jour l'affichage
                    document.getElementById('profilePageAvatar').src = event.target.result;
                    updateUserDisplay();
                    
                    saveAppState();
                    showAlert('loginModal', 'âœ… Photo de profil mise Ã  jour!', 'success');
                };
                reader.readAsDataURL(file);
            });
        }

        function openProfilePage() {
            const page = document.getElementById('profilePage');
            if (!page) return;
            
            // Afficher le contenu du profil
            document.getElementById('profilePageAvatar').src = APP_STATE.user.avatar;
            document.getElementById('profileUsernameDisplay').textContent = APP_STATE.user.displayName;
            document.getElementById('profileUserIdDisplay').textContent = '#' + APP_STATE.user.id.substring(5, 9);
            
            const joinDate = new Date(APP_STATE.user.joinedAt || new Date()).toLocaleDateString('fr-FR');
            document.getElementById('profileJoinDateDisplay').textContent = 'Inscrit le ' + joinDate;
            
            // Afficher les boutons d'Ã©dition seulement pour mon profil
            if (APP_STATE.isLoggedIn) {
                document.getElementById('changeAvatarBtn').style.display = 'block';
                document.getElementById('editUsernameBtn').style.display = 'block';
                document.getElementById('profileActions').style.display = 'flex';
            }
            
            page.style.display = 'flex';
            renderProfileServers();
            renderProfileFriends();
            renderProfileFavorites();
        }

        function closeProfilePage() {
            const page = document.getElementById('profilePage');
            if (page) {
                page.style.display = 'none';
            }
        }

        function editUsername() {
            const input = document.getElementById('profileUsernameInput');
            const display = document.getElementById('profileUsernameDisplay');
            
            if (input.style.display === 'none') {
                input.style.display = 'block';
                display.style.display = 'none';
                input.value = APP_STATE.user.displayName;
                input.focus();
            }
        }

        function saveProfile() {
            const newUsername = document.getElementById('profileUsernameInput').value.trim();
            
            if (newUsername && newUsername.length >= 3 && newUsername.length <= 20) {
                APP_STATE.user.displayName = newUsername;
                APP_STATE.users[APP_STATE.user.email] = APP_STATE.user;
                
                document.getElementById('profileUsernameDisplay').textContent = newUsername;
                document.getElementById('profileUsernameInput').style.display = 'none';
                document.getElementById('profileUsernameDisplay').style.display = 'block';
                
                saveAppState();
                saveUsers();
                showAlert('loginModal', 'âœ… Profil mis Ã  jour!', 'success');
                updateUserDisplay();
            } else {
                showAlert('loginModal', 'Le pseudo doit contenir entre 3 et 20 caractÃ¨res', 'error');
            }
        }

        function renderProfileServers() {
            const serversList = document.getElementById('profileServersList');
            if (!serversList) return;
            
            serversList.innerHTML = '';
            
            const userServers = Object.entries(APP_STATE.servers).filter(([_, server]) => 
                server.createdBy === APP_STATE.user.email || (server.members && server.members.includes(APP_STATE.user.email))
            );
            
            if (userServers.length === 0) {
                serversList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur</div>';
                return;
            }
            
            userServers.forEach(([serverId, server]) => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: all 0.1s;';
                div.innerHTML = `
                    <div style="color: var(--color-accent); font-weight: bold; font-size: 11px;">${server.name}</div>
                    <div style="color: var(--color-text-dim); font-size: 9px; margin-top: 4px;">${server.description || 'Pas de description'}</div>
                `;
                div.onmouseover = () => { div.style.borderColor = 'var(--color-primary)'; };
                div.onmouseout = () => { div.style.borderColor = 'var(--color-border)'; };
                div.onclick = () => { closeProfilePage(); selectServerV2(serverId); };
                serversList.appendChild(div);
            });
        }

        function renderProfileFriends() {
            const friendsList = document.getElementById('profileFriendsAllList');
            if (!friendsList) return;
            
            friendsList.innerHTML = '';
            
            const friends = Object.entries(APP_STATE.friends).filter(([_, f]) => f.status === 'accepted');
            
            if (friends.length === 0) {
                friendsList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun ami</div>';
                return;
            }
            
            friends.forEach(([friendId, friendData]) => {
                const friend = APP_STATE.users[friendId];
                if (!friend) return;
                
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;';
                
                const avatar = document.createElement('img');
                avatar.src = friend.avatar || generateDefaultAvatar();
                avatar.style.cssText = 'width: 32px; height: 32px; border-radius: 0; object-fit: cover;';
                div.appendChild(avatar);
                
                const info = document.createElement('div');
                info.style.cssText = 'flex: 1;';
                info.innerHTML = `
                    <div style="color: var(--color-accent); font-weight: bold; font-size: 10px;">${friend.displayName}</div>
                    <div style="color: var(--color-text-dim); font-size: 8px;">@${friend.username}</div>
                `;
                div.appendChild(info);
                
                friendsList.appendChild(div);
            });
        }

        function renderProfileFavorites() {
            const favoritesList = document.getElementById('profileFavoritesList');
            if (!favoritesList) return;
            
            favoritesList.innerHTML = '';
            
            const favorites = (APP_STATE.user.favoriteServers || []).map(id => APP_STATE.servers[id]).filter(s => s);
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur en favoris</div>';
                return;
            }
            
            favorites.forEach(server => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; border: 1px solid var(--color-primary); border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: all 0.1s; background: rgba(255, 0, 110, 0.1);';
                div.innerHTML = `
                    <div style="color: var(--color-primary); font-weight: bold; font-size: 11px;">â­ ${server.name}</div>
                    <div style="color: var(--color-text-dim); font-size: 9px; margin-top: 4px;">${server.description || 'Pas de description'}</div>
                `;
                div.onmouseover = () => { div.style.borderColor = 'var(--color-accent)'; };
                div.onmouseout = () => { div.style.borderColor = 'var(--color-primary)'; };
                div.onclick = () => { closeProfilePage(); selectServerV2(server.id); };
                favoritesList.appendChild(div);
            });
        }
        function addUserToServer(serverId, userId, rank = 'member') {
            if (!APP_STATE.servers[serverId]) return false;
            
            if (!APP_STATE.servers[serverId].members) {
                APP_STATE.servers[serverId].members = {};
            }
            
            APP_STATE.servers[serverId].members[userId] = {
                joinedAt: new Date().toISOString(),
                rank: rank,
                warnings: 0,
                isBanned: false,
                isMuted: false,
                muteUntil: null
            };
            
            return true;
        }

        // ===== OBTENIR LE RANK D'UN UTILISATEUR DANS UN SERVEUR =====
        function getUserRank(serverId, userId) {
            if (!APP_STATE.servers[serverId] || !APP_STATE.servers[serverId].members[userId]) {
                return RANKS.member;
            }
            const rankName = APP_STATE.servers[serverId].members[userId].rank;
            return RANKS[rankName] || RANKS.member;
        }

        // ===== VÃ‰RIFIER LES PERMISSIONS =====
        function hasPermission(serverId, userId, permission) {
            const userRank = getUserRank(serverId, userId);
            return userRank.permissions && userRank.permissions.includes(permission);
        }

        // ===== CRÃ‰ER UN SERVEUR =====
        function createServer(serverName, description = '', userId = APP_STATE.user?.id) {
            if (!userId) return null;
            
            const serverId = 'server_' + Date.now();
            
            APP_STATE.servers[serverId] = {
                id: serverId,
                name: serverName,
                description: description || 'Nouveau serveur',
                owner: userId,
                createdAt: new Date().toISOString(),
                channels: {
                    general: {
                        id: 'channel_general',
                        name: 'gÃ©nÃ©ral',
                        description: 'Canal principal',
                        messages: [],
                        createdBy: userId,
                        position: 0,
                        isPrivate: false,
                        isVoice: false,
                        typing: []
                    }
                },
                members: {},
                roles: RANKS,
                settings: {
                    isPrivate: false,
                    requireApproval: false,
                    allowInvites: true
                }
            };
            
            // Ajouter le crÃ©ateur comme propriÃ©taire
            addUserToServer(serverId, userId, 'owner');
            
            // Ajouter automatiquement en favoris
            if (!APP_STATE.user.favoriteServers) {
                APP_STATE.user.favoriteServers = [];
            }
            APP_STATE.user.favoriteServers.push(serverId);
            
            saveToLocalStorage();
            return serverId;
        }

        // ===== CRÃ‰ER UN CANAL DANS UN SERVEUR =====
        function createChannel(serverId, channelName, userId) {
            if (!APP_STATE.servers[serverId]) return null;
            if (!hasPermission(serverId, userId, 'manage_channels')) return null;
            
            const channelId = 'channel_' + Date.now();
            const position = Object.keys(APP_STATE.servers[serverId].channels).length;
            
            APP_STATE.servers[serverId].channels[channelId] = {
                id: channelId,
                name: channelName,
                description: '',
                messages: [],
                createdBy: userId,
                position: position,
                isPrivate: false,
                isVoice: false,
                typing: []
            };
            
            return channelId;
        }

        // ===== ENVOYERUNE MESSAGE AVEC MÃ‰TADONNÃ‰ES =====
        function sendMessageAdvanced(content, channelId, userId, serverId, metadata = {}) {
            if (serverId && APP_STATE.servers[serverId] && APP_STATE.servers[serverId].channels[channelId]) {
                const channel = APP_STATE.servers[serverId].channels[channelId];
                
                // VÃ©rifier les permissions
                if (!hasPermission(serverId, userId, 'send_message')) {
                    return { error: 'Permission denied' };
                }
                
                // VÃ©rifier si l'utilisateur est muet
                const memberInfo = APP_STATE.servers[serverId].members[userId];
                if (memberInfo && memberInfo.isMuted && new Date(memberInfo.muteUntil) > new Date()) {
                    return { error: 'User is muted' };
                }
                
                const message = {
                    id: 'msg_' + Date.now(),
                    from: userId,
                    content: content,
                    timestamp: new Date().toISOString(),
                    edited: false,
                    editedAt: null,
                    reactions: {},
                    ...metadata
                };
                
                channel.messages.push(message);
                saveToLocalStorage();
                return message;
            }
            
            return { error: 'Channel not found' };
        }

        // ===== MESSAGES PRIVÃ‰S (DMs) =====
        function sendDM(senderId, recipientId, content) {
            const dmKey = [senderId, recipientId].sort().join('_');
            
            if (!APP_STATE.directMessages[dmKey]) {
                APP_STATE.directMessages[dmKey] = [];
            }
            
            const message = {
                id: 'dm_' + Date.now(),
                from: senderId,
                to: recipientId,
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            APP_STATE.directMessages[dmKey].push(message);
            saveToLocalStorage();
            return message;
        }

        // ===== OBTENIR TOUS LES DMs AVEC UN UTILISATEUR =====
        function getDMHistory(userId1, userId2) {
            const dmKey = [userId1, userId2].sort().join('_');
            return APP_STATE.directMessages[dmKey] || [];
        }

        // ===== AJOUTER UN AMI =====
        function addFriend(userId, friendId) {
            if (!APP_STATE.friends) APP_STATE.friends = {};
            
            const friendKey = [userId, friendId].sort().join('_');
            APP_STATE.friends[friendKey] = {
                users: [userId, friendId],
                status: 'pending',
                requestedBy: userId,
                addedAt: new Date().toISOString()
            };
            
            saveToLocalStorage();
            return true;
        }

        // ===== ACCEPTER UNE DEMANDE D'AMI =====
        function acceptFriendRequest(userId, friendId) {
            const friendKey = [userId, friendId].sort().join('_');
            
            if (APP_STATE.friends[friendKey]) {
                APP_STATE.friends[friendKey].status = 'accepted';
                saveToLocalStorage();
                return true;
            }
            
            return false;
        }

        // ===== BLOQUER UN UTILISATEUR =====
        function blockUser(userId, blockedUserId) {
            if (!APP_STATE.blocked) APP_STATE.blocked = [];
            
            if (!APP_STATE.blocked.includes(blockedUserId)) {
                APP_STATE.blocked.push(blockedUserId);
                saveToLocalStorage();
            }
            
            return true;
        }

        // ===== OBTENIR LA LISTE DES AMIS =====
        function getFriendsList(userId) {
            if (!APP_STATE.friends) return [];
            
            const friends = [];
            Object.values(APP_STATE.friends).forEach(friendship => {
                if (friendship.status === 'accepted' && friendship.users.includes(userId)) {
                    const friendId = friendship.users.find(id => id !== userId);
                    friends.push({
                        id: friendId,
                        ...APP_STATE.users[friendId]
                    });
                }
            });
            
            return friends;
        }

        // ===== MODÃ‰RATION: AVERTIR UN UTILISATEUR =====
        function warnUser(serverId, userId, reason) {
            if (!APP_STATE.servers[serverId].members[userId]) return false;
            
            const member = APP_STATE.servers[serverId].members[userId];
            if (!member.warnings) member.warnings = 0;
            member.warnings++;
            
            // Bannir aprÃ¨s 3 avertissements
            if (member.warnings >= 3) {
                banUser(serverId, userId, 'Trop d\'avertissements');
            }
            
            if (!APP_STATE.warnings) APP_STATE.warnings = {};
            if (!APP_STATE.warnings[serverId]) APP_STATE.warnings[serverId] = {};
            if (!APP_STATE.warnings[serverId][userId]) APP_STATE.warnings[serverId][userId] = [];
            
            APP_STATE.warnings[serverId][userId].push({
                reason: reason,
                timestamp: new Date().toISOString()
            });
            
            saveToLocalStorage();
            return true;
        }

        // ===== MODÃ‰RATION: BANNIR UN UTILISATEUR =====
        function banUser(serverId, userId, reason = 'Aucune raison') {
            if (!APP_STATE.servers[serverId].members[userId]) return false;
            
            APP_STATE.servers[serverId].members[userId].isBanned = true;
            
            if (!APP_STATE.bans) APP_STATE.bans = {};
            if (!APP_STATE.bans[serverId]) APP_STATE.bans[serverId] = [];
            
            APP_STATE.bans[serverId].push({
                userId: userId,
                reason: reason,
                timestamp: new Date().toISOString(),
                bannedBy: APP_STATE.user ? APP_STATE.user.id : 'system'
            });
            
            saveToLocalStorage();
            return true;
        }

        // ===== MODÃ‰RATION: RENDRE MUET UN UTILISATEUR =====
        function muteUser(serverId, userId, durationMinutes = 60) {
            if (!APP_STATE.servers[serverId].members[userId]) return false;
            
            const muteUntil = new Date();
            muteUntil.setMinutes(muteUntil.getMinutes() + durationMinutes);
            
            APP_STATE.servers[serverId].members[userId].isMuted = true;
            APP_STATE.servers[serverId].members[userId].muteUntil = muteUntil.toISOString();
            
            saveToLocalStorage();
            return true;
        }

        // ===== MODÃ‰RATION: SUPPRIMER UN MESSAGE =====
        function deleteMessage(serverId, channelId, messageId, userId) {
            if (!APP_STATE.servers[serverId] || !APP_STATE.servers[serverId].channels[channelId]) return false;
            
            const channel = APP_STATE.servers[serverId].channels[channelId];
            const messageIndex = channel.messages.findIndex(m => m.id === messageId);
            
            if (messageIndex === -1) return false;
            
            const message = channel.messages[messageIndex];
            
            // VÃ©rifier les permissions
            if (message.from !== userId && !hasPermission(serverId, userId, 'delete_message')) {
                return false;
            }
            
            channel.messages.splice(messageIndex, 1);
            saveToLocalStorage();
            return true;
        }

        // ===== STATUT UTILISATEUR =====
        function setUserStatus(userId, status) {
            if (!APP_STATE.userPresence) APP_STATE.userPresence = {};
            
            APP_STATE.userPresence[userId] = {
                status: status, // 'online', 'idle', 'dnd', 'offline'
                lastSeen: new Date().toISOString(),
                currentServerId: APP_STATE.currentServerId,
                currentChannelId: APP_STATE.currentChannelId
            };
            
            saveToLocalStorage();
        }

        // ===== OBTENIR LE STATUT D'UN UTILISATEUR =====
        function getUserStatus(userId) {
            if (!APP_STATE.userPresence || !APP_STATE.userPresence[userId]) {
                return 'offline';
            }
            return APP_STATE.userPresence[userId].status;
        }

        // ===== SAUVEGARDER DANS LOCALSTORAGE =====
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    users: APP_STATE.users,
                    servers: APP_STATE.servers,
                    channels: APP_STATE.channels,
                    directMessages: APP_STATE.directMessages,
                    friends: APP_STATE.friends,
                    blocked: APP_STATE.blocked,
                    bans: APP_STATE.bans,
                    warnings: APP_STATE.warnings,
                    userPresence: APP_STATE.userPresence,
                    privateChats: APP_STATE.privateChats
                };
                
                localStorage.setItem('pixendUsers', JSON.stringify(APP_STATE.users));
                localStorage.setItem('pixendServers', JSON.stringify(APP_STATE.servers));
                localStorage.setItem('pixendChannels', JSON.stringify(APP_STATE.channels));
                localStorage.setItem('pixendDMs', JSON.stringify(APP_STATE.directMessages));
                localStorage.setItem('pixendFriends', JSON.stringify(APP_STATE.friends));
                localStorage.setItem('pixendBlocked', JSON.stringify(APP_STATE.blocked));
                localStorage.setItem('pixendBans', JSON.stringify(APP_STATE.bans));
                localStorage.setItem('pixendWarnings', JSON.stringify(APP_STATE.warnings));
                localStorage.setItem('pixendPresence', JSON.stringify(APP_STATE.userPresence));
            } catch (e) {
                console.error('Erreur lors de la sauvegarde:', e);
            }
        }

        // ===== CHARGER DEPUIS LOCALSTORAGE =====
        function loadFromLocalStorage() {
            try {
                const servers = JSON.parse(localStorage.getItem('pixendServers')) || {};
                const channels = JSON.parse(localStorage.getItem('pixendChannels')) || {};
                const dms = JSON.parse(localStorage.getItem('pixendDMs')) || {};
                const friends = JSON.parse(localStorage.getItem('pixendFriends')) || {};
                const blocked = JSON.parse(localStorage.getItem('pixendBlocked')) || [];
                const bans = JSON.parse(localStorage.getItem('pixendBans')) || {};
                const warnings = JSON.parse(localStorage.getItem('pixendWarnings')) || {};
                const presence = JSON.parse(localStorage.getItem('pixendPresence')) || {};
                
                Object.assign(APP_STATE.servers, servers);
                Object.assign(APP_STATE.channels, channels);
                Object.assign(APP_STATE.directMessages, dms);
                Object.assign(APP_STATE.friends, friends);
                APP_STATE.blocked = blocked;
                Object.assign(APP_STATE.bans, bans);
                Object.assign(APP_STATE.warnings, warnings);
                Object.assign(APP_STATE.userPresence, presence);
            } catch (e) {
                console.error('Erreur lors du chargement:', e);
            }
        }

        // ===== TOGGLE MOT DE PASSE =====
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
        }

        // ===== SONS RÃ‰TRO =====
        const SOUNDS = {
            message: null,
            click: null,
            connect: null
        };

        function createRetroSounds() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            SOUNDS.message = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(400, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            };

            SOUNDS.click = () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(600, audioContext.currentTime);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.05);
            };

            SOUNDS.connect = () => {
                const notes = [329.63, 392, 493.88];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
                    gain.gain.setValueAtTime(0.1, audioContext.currentTime + i * 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.15);
                    osc.start(audioContext.currentTime + i * 0.1);
                    osc.stop(audioContext.currentTime + i * 0.1 + 0.15);
                });
            };
        }

        // ===== VALIDATION EMAIL =====
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // ===== GESTION DES UTILISATEURS =====
        function generateAnonymousUser() {
            const num = Math.floor(Math.random() * 9000) + 1000;
            return {
                id: 'anon_' + num,
                username: 'Anonyme',
                displayName: 'Anonyme #' + num,
                email: null,
                isAnonymous: true,
                avatar: generateDefaultAvatar(),
                favoriteChannels: [],
                favoriteServers: [],
                createdAt: new Date().toISOString()
            };
        }

        function generateDefaultAvatar() {
            const colors = ['#ff006e', '#00d4ff', '#ffff00', '#ff0080', '#00ff80'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            for (let i = 0; i < 32; i += 4) {
                for (let j = 0; j < 32; j += 4) {
                    if (Math.random() > 0.5) {
                        ctx.fillRect(i, j, 4, 4);
                    }
                }
            }
            return canvas.toDataURL();
        }

        // ===== PAGE D'ACCUEIL =====
        function showWelcome() {
            document.getElementById('welcomeScreen').classList.add('active');
            document.getElementById('mainContainer').style.display = 'none';
            switchWelcomeView('main');
            renderPreviewChannels();
        }

        function hideWelcome() {
            document.getElementById('welcomeScreen').classList.remove('active');
            document.getElementById('mainContainer').style.display = 'flex';
        }

        function switchWelcomeView(viewName) {
            document.getElementById('welcomeMainView').classList.remove('active');
            document.getElementById('welcomeLoginView').classList.remove('active');
            document.getElementById('welcomeRegisterView').classList.remove('active');

            switch(viewName) {
                case 'main':
                    document.getElementById('welcomeMainView').classList.add('active');
                    break;
                case 'login':
                    document.getElementById('welcomeLoginView').classList.add('active');
                    document.getElementById('welcomeLoginEmail').value = '';
                    document.getElementById('welcomeLoginPassword').value = '';
                    document.getElementById('loginWelcomeAlert').innerHTML = '';
                    break;
                case 'register':
                    document.getElementById('welcomeRegisterView').classList.add('active');
                    document.getElementById('welcomeRegisterUsername').value = '';
                    document.getElementById('welcomeRegisterEmail').value = '';
                    document.getElementById('welcomeRegisterPassword').value = '';
                    document.getElementById('welcomeRegisterPasswordConfirm').value = '';
                    document.getElementById('registerWelcomeAlert').innerHTML = '';
                    break;
            }
        }

        function renderPreviewChannels() {
            const preview = document.getElementById('previewChannels');
            preview.innerHTML = '';
            Object.entries(APP_STATE.channels).forEach(([key, channel]) => {
                const div = document.createElement('div');
                div.className = 'channel-preview-item';
                // Afficher le nombre rÃ©el d'utilisateurs dans CE salon
                const usersInChannel = APP_STATE.activeChannelUsers[key] || [];
                const onlineCount = usersInChannel.length;
                div.innerHTML = `${channel.name} (${onlineCount} ðŸŸ¢)`;
                preview.appendChild(div);
            });
        }

        function showWelcomeAlert(alertId, message, type = 'error') {
            const alertDiv = document.getElementById(alertId);
            alertDiv.innerHTML = `<div class="${type}">${message}</div>`;
            if (type === 'error') {
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 5000);
            }
        }

        function welcomeLoginUser() {
            const email = document.getElementById('welcomeLoginEmail').value.trim();
            const password = document.getElementById('welcomeLoginPassword').value.trim();

            if (!email || !password) {
                showWelcomeAlert('loginWelcomeAlert', 'Veuillez remplir tous les champs', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showWelcomeAlert('loginWelcomeAlert', 'Email invalide', 'error');
                return;
            }

            // Envoyer la requÃªte au serveur backend
            const apiUrl = (window.PIXEND_CONFIG?.apiUrl || window.location.protocol + '//' + window.location.host + '/api') + '/users/login';
            
            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(r => {
                if (r.status === 401) {
                    showWelcomeAlert('loginWelcomeAlert', 'Email ou mot de passe incorrect', 'error');
                    throw new Error('Invalid credentials');
                }
                if (!r.ok) throw new Error('Erreur serveur');
                return r.json();
            })
            .then(data => {
                if (!data.success || !data.user) throw new Error('RÃ©ponse invalide');
                
                const userData = data.user;

                // Retirer l'utilisateur anonyme de la liste
                removeUserOnline(APP_STATE.user.id);
                
                APP_STATE.user = userData;
                APP_STATE.isLoggedIn = true;
                APP_STATE.users[email] = userData;
                
                // Ajouter l'utilisateur connectÃ© Ã  la liste
                addUserOnline(userData.id);
                setUserStatus(userData.id, 'online');
                
                document.getElementById('logoutBtn').style.display = 'block';
                updateUserDisplay();
                hideWelcome();
                saveAppState();
                saveToLocalStorage();
                SOUNDS.connect?.();
            })
            .catch(err => {
                console.error('âŒ Erreur connexion:', err);
                showWelcomeAlert('loginWelcomeAlert', 'Erreur de connexion. VÃ©rifiez le serveur.', 'error');
            });
        }

        function welcomeRegisterUser() {
            const username = document.getElementById('welcomeRegisterUsername').value.trim();
            const email = document.getElementById('welcomeRegisterEmail').value.trim();
            const password = document.getElementById('welcomeRegisterPassword').value.trim();
            const passwordConfirm = document.getElementById('welcomeRegisterPasswordConfirm').value.trim();

            if (!username || !email || !password || !passwordConfirm) {
                showWelcomeAlert('registerWelcomeAlert', 'Tous les champs sont requis', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showWelcomeAlert('registerWelcomeAlert', 'Email invalide', 'error');
                return;
            }

            if (username.length < 3 || username.length > 20) {
                showWelcomeAlert('registerWelcomeAlert', 'Le pseudo doit contenir entre 3 et 20 caractÃ¨res', 'error');
                return;
            }

            if (password.length < 6) {
                showWelcomeAlert('registerWelcomeAlert', 'Le mot de passe doit contenir au moins 6 caractÃ¨res', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showWelcomeAlert('registerWelcomeAlert', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }

            // Envoyer la requÃªte au serveur backend
            const apiUrl = (window.PIXEND_CONFIG?.apiUrl || window.location.protocol + '//' + window.location.host + '/api') + '/users/register';
            const avatar = generateDefaultAvatar();
            
            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password, avatar })
            })
            .then(r => {
                if (r.status === 400) {
                    showWelcomeAlert('registerWelcomeAlert', 'Cet email est dÃ©jÃ  inscrit', 'error');
                    throw new Error('Email exists');
                }
                if (!r.ok) throw new Error('Erreur serveur');
                return r.json();
            })
            .then(data => {
                if (!data.success || !data.user) throw new Error('RÃ©ponse invalide');
                
                const userData = data.user;

                // Retirer l'utilisateur anonyme de la liste
                removeUserOnline(APP_STATE.user.id);
                
                APP_STATE.user = userData;
                APP_STATE.isLoggedIn = true;
                APP_STATE.users[email] = userData;
                
                // Ajouter Ã  tous les serveurs publics
                Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                    if (!server.settings.isPrivate) {
                        addUserToServer(serverId, userData.id, 'member');
                    }
                });
                
                setUserStatus(userData.id, 'online');
                document.getElementById('logoutBtn').style.display = 'block';
                updateUserDisplay();
                hideWelcome();
                saveAppState();
                saveToLocalStorage();
                SOUNDS.connect?.();
            })
            .catch(err => {
                console.error('âŒ Erreur inscription:', err);
                showWelcomeAlert('registerWelcomeAlert', 'Erreur lors de l\'inscription. VÃ©rifiez le serveur.', 'error');
            });
        }

        // ===== INITIALISATION =====
        function initApp() {
            // Charger les donnÃ©es sauvegardÃ©es
            loadFromLocalStorage();
            
            // CrÃ©er un serveur gÃ©nÃ©ral s'il n'existe pas
            if (!APP_STATE.servers['server_general']) {
                APP_STATE.servers['server_general'] = {
                    id: 'server_general',
                    name: 'ðŸŒ GÃ‰NÃ‰RAL',
                    description: 'Serveur public accessible Ã  tous',
                    isPublic: true,
                    isGeneral: true,
                    createdBy: 'system',
                    createdAt: new Date().toISOString(),
                    channels: {
                        'channel_general': {
                            id: 'channel_general',
                            name: 'gÃ©nÃ©ral',
                            description: 'Canal principal public',
                            messages: [],
                            isPublic: true
                        }
                    }
                };
            }
            
            // RÃ©initialiser les utilisateurs actifs Ã  chaque chargement
            APP_STATE.activeChannelUsers = {};
            
            APP_STATE.user = generateAnonymousUser();
            createRetroSounds();
            
            // Ajouter l'utilisateur courant Ã  la liste des utilisateurs en ligne
            addUserOnline(APP_STATE.user.id);
            setUserStatus(APP_STATE.user.id, 'online');
            
            updateUserDisplay();
            renderChannels();
            selectChannel('general');
            setupEventListeners();
            showWelcome();
            SOUNDS.connect?.();
        }

        // ===== TRACKING UTILISATEURS EN LIGNE =====
        function addUserOnline(userId) {
            if (!APP_STATE.onlineUsers.includes(userId)) {
                APP_STATE.onlineUsers.push(userId);
                renderChannels(); // Mettre Ã  jour la sidebar avec le nouveau count
            }
        }

        function removeUserOnline(userId) {
            const index = APP_STATE.onlineUsers.indexOf(userId);
            if (index > -1) {
                APP_STATE.onlineUsers.splice(index, 1);
                renderChannels(); // Mettre Ã  jour la sidebar
            }
        }

        // ===== AFFICHAGE DES SALONS =====
        // ===== AFFICHAGE AMÃ‰LIORÃ‰ DES SALONS, SERVEURS ET AMIS =====
        function renderChannels() {
            const channelsList = document.getElementById('channelsList');
            channelsList.innerHTML = '';

            // ===== SECTION SERVEURS =====
            if (Object.keys(APP_STATE.servers).length > 0) {
                const serversHeader = document.createElement('div');
                serversHeader.style.cssText = 'padding: 12px 8px; font-size: 8px; color: var(--color-accent); font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--color-border);';
                serversHeader.textContent = 'ðŸ“¦ SERVEURS';
                channelsList.appendChild(serversHeader);

                Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                    const serverDiv = document.createElement('div');
                    serverDiv.className = `channel-item ${APP_STATE.currentServerId === serverId ? 'active' : ''}`;
                    serverDiv.style.cssText = 'padding-left: 16px; border-left: 3px solid var(--color-primary);';
                    serverDiv.innerHTML = `<span>ðŸ“Œ ${server.name}</span>`;
                    serverDiv.onclick = () => {
                        APP_STATE.currentServerId = serverId;
                        // SÃ©lectionner le premier canal du serveur
                        const firstChannelId = Object.keys(server.channels)[0];
                        if (firstChannelId) {
                            APP_STATE.currentChannelId = firstChannelId;
                            updateChatArea();
                        }
                        renderChannels();
                    };
                    channelsList.appendChild(serverDiv);

                    // Afficher les canaux du serveur
                    if (APP_STATE.currentServerId === serverId) {
                        Object.entries(server.channels).forEach(([channelId, channel]) => {
                            const chanDiv = document.createElement('div');
                            chanDiv.className = `channel-item ${APP_STATE.currentChannelId === channelId ? 'active' : ''}`;
                            chanDiv.style.cssText = 'padding-left: 32px; font-size: 10px;';
                            chanDiv.innerHTML = `<span>#${channel.name}</span>`;
                            chanDiv.onclick = () => {
                                APP_STATE.currentChannelId = channelId;
                                updateChatArea();
                                renderChannels();
                            };
                            channelsList.appendChild(chanDiv);
                        });
                    }
                });
            }

            // ===== SECTION SALONS GÃ‰NÃ‰RAUX =====
            if (Object.keys(APP_STATE.channels).length > 0) {
                const channelsHeader = document.createElement('div');
                channelsHeader.style.cssText = 'padding: 12px 8px; font-size: 8px; color: var(--color-accent); font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--color-border); margin-top: 12px;';
                channelsHeader.textContent = 'ðŸ’¬ SALONS';
                channelsList.appendChild(channelsHeader);

                Object.entries(APP_STATE.channels).forEach(([key, channel]) => {
                    const div = document.createElement('div');
                    div.className = `channel-item ${key === APP_STATE.currentChannel && !APP_STATE.currentServerId ? 'active' : ''}`;
                    
                    const usersInChannel = APP_STATE.activeChannelUsers[key] || [];
                    const onlineCount = usersInChannel.length;
                    
                    div.innerHTML = `<span>#${channel.name}</span><span style="font-size: 9px; color: var(--color-accent); margin-left: 4px;">(${onlineCount})</span>`;
                    div.onclick = () => {
                        closeChannelMenu();
                        APP_STATE.currentServerId = null;
                        APP_STATE.currentChannelId = null;
                        selectChannel(key);
                        renderChannels();
                    };
                    channelsList.appendChild(div);
                });
            }

            // ===== SECTION AMIS & DMs =====
            const friends = getFriendsList(APP_STATE.user.id);
            if (friends.length > 0 || Object.keys(APP_STATE.directMessages).length > 0) {
                const dmsHeader = document.createElement('div');
                dmsHeader.style.cssText = 'padding: 12px 8px; font-size: 8px; color: var(--color-accent); font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--color-border); margin-top: 12px;';
                dmsHeader.textContent = 'ðŸ‘¥ MESSAGES DIRECTS';
                channelsList.appendChild(dmsHeader);

                friends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'channel-item dm-item';
                    const status = getUserStatus(friend.id);
                    const statusColor = status === 'online' ? '#00ff00' : '#666666';
                    
                    friendDiv.innerHTML = `<span class="online-indicator" style="background-color: ${statusColor}; box-shadow: 0 0 4px ${statusColor};"></span><span>${friend.displayName}</span>`;
                    friendDiv.onclick = () => {
                        APP_STATE.currentDMUserId = friend.id;
                        APP_STATE.currentServerId = null;
                        APP_STATE.currentChannelId = null;
                        updateChatArea();
                        renderChannels();
                    };
                    channelsList.appendChild(friendDiv);
                });
            }

            // ===== SECTION MESSAGES PRIVÃ‰S CLASSIQUES =====
            Object.entries(APP_STATE.privateChats).forEach(([key, chat]) => {
                const div = document.createElement('div');
                div.className = `channel-item private ${key === APP_STATE.currentChannel ? 'active' : ''}`;
                div.textContent = 'ðŸ’¬ ' + chat.otherUser.displayName;
                div.onclick = () => {
                    closeChannelMenu();
                    APP_STATE.currentServerId = null;
                    APP_STATE.currentChannelId = null;
                    selectChannel(key);
                    renderChannels();
                };
                channelsList.appendChild(div);
            });
        }

        // ===== SÃ‰LECTION D'UN SALON =====
        function selectChannel(channelKey) {
            // Mettre Ã  jour le salon courant
            const previousChannel = APP_STATE.currentChannel;
            APP_STATE.currentChannel = channelKey;
            
            // Enlever l'utilisateur du salon prÃ©cÃ©dent
            if (previousChannel && APP_STATE.activeChannelUsers[previousChannel]) {
                const index = APP_STATE.activeChannelUsers[previousChannel].indexOf(APP_STATE.user.id);
                if (index > -1) {
                    APP_STATE.activeChannelUsers[previousChannel].splice(index, 1);
                }
            }
            
            // Ajouter l'utilisateur au nouveau salon
            if (!APP_STATE.activeChannelUsers[channelKey]) {
                APP_STATE.activeChannelUsers[channelKey] = [];
            }
            if (!APP_STATE.activeChannelUsers[channelKey].includes(APP_STATE.user.id)) {
                APP_STATE.activeChannelUsers[channelKey].push(APP_STATE.user.id);
            }
            
            const isPrivate = APP_STATE.privateChats[channelKey];
            
            if (isPrivate) {
                document.getElementById('channelName').textContent = 'ðŸ’¬ ' + APP_STATE.privateChats[channelKey].otherUser.displayName;
                document.getElementById('channelMenuBtn').style.display = 'none';
            } else {
                const channel = APP_STATE.channels[channelKey];
                document.getElementById('channelName').textContent = '#' + channel.name;
                document.getElementById('channelMenuBtn').style.display = 'inline-block';
            }

            // Afficher le bouton profil si connectÃ©
            if (APP_STATE.isLoggedIn) {
                document.getElementById('profileBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
            }

            renderMessages();
            renderChannels();
            SOUNDS.click?.();
        }

        // ===== METTRE Ã€ JOUR LA ZONE DE CHAT =====
        function updateChatArea() {
            const channelNameEl = document.getElementById('channelName');
            
            // Si c'est un serveur
            if (APP_STATE.currentServerId && APP_STATE.currentChannelId) {
                const server = APP_STATE.servers[APP_STATE.currentServerId];
                const channel = server.channels[APP_STATE.currentChannelId];
                
                if (channel) {
                    channelNameEl.textContent = `ðŸ“Œ ${server.name} > #${channel.name}`;
                    document.getElementById('channelMenuBtn').style.display = 'inline-block';
                }
            }
            // Si c'est un DM ami
            else if (APP_STATE.currentDMUserId) {
                const friend = APP_STATE.users[APP_STATE.currentDMUserId];
                if (friend) {
                    const status = getUserStatus(APP_STATE.currentDMUserId);
                    const statusIndicator = status === 'online' ? 'ðŸŸ¢' : 'âšª';
                    channelNameEl.textContent = `${statusIndicator} ${friend.displayName}`;
                    document.getElementById('channelMenuBtn').style.display = 'none';
                }
            }
            // Sinon utiliser l'ancien systÃ¨me
            else if (APP_STATE.currentChannel) {
                selectChannel(APP_STATE.currentChannel);
                return;
            }
            
            renderMessages();
            setupTypingIndicator();
        }

        // ===== AFFICHAGE DES MESSAGES AMÃ‰LIORÃ‰ =====
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            let messages = [];
            let typingUsers = [];
            
            // SERVEURS: charger les messages du canal du serveur
            if (APP_STATE.currentServerId && APP_STATE.currentChannelId && APP_STATE.servers[APP_STATE.currentServerId]) {
                const channel = APP_STATE.servers[APP_STATE.currentServerId].channels[APP_STATE.currentChannelId];
                if (channel) {
                    messages = channel.messages || [];
                    typingUsers = channel.typing || [];
                }
            }
            // DMs AMIS: charger l'historique
            else if (APP_STATE.currentDMUserId) {
                const dmKey = [APP_STATE.user.id, APP_STATE.currentDMUserId].sort().join('_');
                messages = APP_STATE.directMessages[dmKey] || [];
            }
            // ANCIEN SYSTÃˆME: Messages privÃ©s classiques
            else if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                messages = APP_STATE.privateChats[APP_STATE.currentChannel].messages;
                typingUsers = APP_STATE.privateChats[APP_STATE.currentChannel].typing || [];
            }
            // ANCIEN SYSTÃˆME: Salons classiques
            else if (APP_STATE.channels[APP_STATE.currentChannel]) {
                messages = APP_STATE.channels[APP_STATE.currentChannel].messages;
                typingUsers = APP_STATE.channels[APP_STATE.currentChannel].typing || [];
            }

            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun message pour le moment...</div>';
            } else {
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    if (msg.avatar) {
                        const img = document.createElement('img');
                        img.src = msg.avatar;
                        avatar.appendChild(img);
                    } else {
                        avatar.textContent = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
                    }
                    msgDiv.appendChild(avatar);

                    const content = document.createElement('div');
                    content.className = 'message-content';

                    const header = document.createElement('div');
                    header.className = 'message-header';
                    
                    const author = document.createElement('span');
                    author.className = 'message-author';
                    author.textContent = msg.username || 'Anonyme';
                    
                    // Ajouter le badge de rank si prÃ©sent
                    if (msg.rank && RANKS[msg.rank]) {
                        const rankBadge = document.createElement('span');
                        rankBadge.className = 'rank-badge';
                        rankBadge.style.color = RANKS[msg.rank].color;
                        rankBadge.style.marginLeft = '8px';
                        rankBadge.textContent = RANKS[msg.rank].symbol + ' ' + RANKS[msg.rank].name;
                        header.appendChild(rankBadge);
                    }
                    
                    header.appendChild(author);

                    const time = document.createElement('span');
                    time.className = 'message-time';
                    time.textContent = msg.time || new Date(msg.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    header.appendChild(time);

                    content.appendChild(header);

                    if (msg.imageUrl) {
                        const img = document.createElement('img');
                        img.src = msg.imageUrl;
                        img.style.maxWidth = '150px';
                        img.style.marginBottom = '4px';
                        img.style.border = '2px solid var(--color-primary)';
                        content.appendChild(img);
                    }

                    const text = document.createElement('div');
                    text.className = 'message-text';
                    text.textContent = msg.text || msg.content || '';
                    content.appendChild(text);

                    // Badge d'Ã©dition si le message a Ã©tÃ© Ã©ditÃ©
                    if (msg.edited) {
                        const editedBadge = document.createElement('span');
                        editedBadge.className = 'edited-badge';
                        editedBadge.style.fontSize = '9px';
                        editedBadge.style.color = 'var(--color-text-dim)';
                        editedBadge.style.marginTop = '4px';
                        editedBadge.textContent = '(Ã©ditÃ©)';
                        content.appendChild(editedBadge);
                    }

                    msgDiv.appendChild(content);
                    container.appendChild(msgDiv);
                });
            }

            // Affichage de l'indicateur de saisie
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingUsers && typingUsers.length > 0) {
                typingIndicator.classList.add('active');
                if (typingUsers.length === 1) {
                    typingIndicator.textContent = '> ' + typingUsers[0] + ' est en train d\'Ã©crire...';
                } else {
                    typingIndicator.textContent = '> Plusieurs personnes Ã©crivent...';
                }
            } else {
                typingIndicator.classList.remove('active');
            }

            container.scrollTop = container.scrollHeight;
        }

        // ===== ENVOI DE MESSAGE AMÃ‰LIORÃ‰ =====
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const time = `${hours}:${minutes}`;

            // V2: Envoyer Ã  un canal d'un serveur
            if (APP_STATE.currentServerId && APP_STATE.currentChannelId) {
                const serverId = APP_STATE.currentServerId;
                const channelId = APP_STATE.currentChannelId;
                
                // VÃ©rifier les permissions
                if (!hasPermission(serverId, APP_STATE.user.id, 'send_message')) {
                    alert('âŒ Vous n\'avez pas la permission d\'envoyer des messages dans ce canal!');
                    return;
                }
                
                // VÃ©rifier si l'utilisateur est muet
                const memberInfo = APP_STATE.servers[serverId].members[APP_STATE.user.id];
                if (memberInfo && memberInfo.isMuted && new Date(memberInfo.muteUntil) > new Date()) {
                    alert('âŒ Vous Ãªtes rendu muet sur ce serveur!');
                    return;
                }

                const msg = {
                    id: 'msg_' + Date.now(),
                    from: APP_STATE.user.id,
                    author: APP_STATE.user.email || APP_STATE.user.id,
                    username: APP_STATE.user.displayName,
                    userId: APP_STATE.user.id,
                    content: text,
                    text: text,
                    timestamp: new Date().toISOString(),
                    time: time,
                    avatar: APP_STATE.user.avatar,
                    displayName: APP_STATE.user.displayName,
                    imageUrl: null,
                    rank: APP_STATE.servers[serverId].members[APP_STATE.user.id].rank,
                    edited: false,
                    reactions: {},
                    serverId: serverId,
                    channelId: channelId
                };

                if (APP_STATE.servers[serverId] && APP_STATE.servers[serverId].channels[channelId]) {
                    APP_STATE.servers[serverId].channels[channelId].messages.push(msg);
                    APP_STATE.servers[serverId].channels[channelId].typing = [];
                    
                    // Envoyer via WebSocket si connectÃ©
                    if (socket && socket.connected) {
                        socket.emit('message:send', msg);
                        console.log('ðŸ“¤ Message envoyÃ© via WebSocket vers', channelId);
                    } else {
                        console.log('âš ï¸ Message sauvegardÃ© localement (WebSocket non connectÃ©)');
                    }
                }
            }
            // V1: Utiliser l'ancien systÃ¨me si nÃ©cessaire
            else if (APP_STATE.currentChannel) {
                const msg = {
                    username: APP_STATE.user.displayName,
                    userId: APP_STATE.user.id,
                    author: APP_STATE.user.email || APP_STATE.user.id,
                    text: text,
                    content: text,
                    time: time,
                    timestamp: new Date().toISOString(),
                    avatar: APP_STATE.user.avatar,
                    displayName: APP_STATE.user.displayName,
                    imageUrl: null
                };

                if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                    APP_STATE.privateChats[APP_STATE.currentChannel].messages.push(msg);
                    APP_STATE.privateChats[APP_STATE.currentChannel].typing = [];
                } else if (APP_STATE.channels[APP_STATE.currentChannel]) {
                    APP_STATE.channels[APP_STATE.currentChannel].messages.push(msg);
                    APP_STATE.channels[APP_STATE.currentChannel].typing = [];
                    
                    // Envoyer via WebSocket pour le systÃ¨me ancien aussi
                    if (socket && socket.connected) {
                        socket.emit('message:send', {
                            ...msg,
                            channelId: APP_STATE.currentChannel
                        });
                    }
                }
            }

            SOUNDS.message?.();
            input.value = '';
            renderMessages();
            renderChatArea();
            saveAppState();
            saveToLocalStorage();
        }

        // ===== INDICATEUR D'Ã‰CRITURE =====
        function setupTypingIndicator() {
            const input = document.getElementById('messageInput');
            input.addEventListener('input', () => {
                // Ajouter l'utilisateur Ã  la liste des personnes qui Ã©crivent
                if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                    const chat = APP_STATE.privateChats[APP_STATE.currentChannel];
                    if (!chat.typing.includes(APP_STATE.user.displayName)) {
                        chat.typing.push(APP_STATE.user.displayName);
                    }
                } else {
                    const channel = APP_STATE.channels[APP_STATE.currentChannel];
                    if (!channel.typing.includes(APP_STATE.user.displayName)) {
                        channel.typing.push(APP_STATE.user.displayName);
                    }
                }

                // Simuler d'autres utilisateurs occasionnellement
                if (Math.random() > 0.8 && APP_STATE.channels[APP_STATE.currentChannel].messages.length > 0) {
                    const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve'];
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                        const chat = APP_STATE.privateChats[APP_STATE.currentChannel];
                        if (!chat.typing.includes(randomName)) {
                            chat.typing.push(randomName);
                        }
                    } else {
                        const channel = APP_STATE.channels[APP_STATE.currentChannel];
                        if (!channel.typing.includes(randomName) && Math.random() > 0.6) {
                            channel.typing.push(randomName);
                        }
                    }
                    renderMessages();
                }

                // Effacer aprÃ¨s un dÃ©lai
                clearTimeout(APP_STATE.typingTimeout);
                APP_STATE.typingTimeout = setTimeout(() => {
                    if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                        APP_STATE.privateChats[APP_STATE.currentChannel].typing = [];
                    } else {
                        APP_STATE.channels[APP_STATE.currentChannel].typing = [];
                    }
                    renderMessages();
                }, 2000);
            });
        }

        // ===== CRÃ‰ATION DE SALON =====
        function createChannel() {
            const nameInput = document.getElementById('channelNameInput');
            const descInput = document.getElementById('channelDescInput');
            const name = nameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
            const desc = descInput.value.trim();

            if (!name) {
                alert('Veuillez entrer un nom de salon');
                return;
            }

            if (APP_STATE.channels[name]) {
                alert('Ce salon existe dÃ©jÃ ');
                return;
            }

            APP_STATE.channels[name] = {
                name: name,
                description: desc || 'Pas de description',
                messages: [],
                createdBy: APP_STATE.user.id,
                isPrivate: false,
                typing: []
            };

            nameInput.value = '';
            descInput.value = '';
            closeModal('newChannelModal');
            selectChannel(name);
            renderChannels();
            renderPreviewChannels();
            saveAppState();
        }

        // ===== GESTION DE LA CONNEXION =====
        function updateUserDisplay() {
            document.getElementById('userName').textContent = APP_STATE.user.displayName;
            document.getElementById('userAvatar').innerHTML = '';
            const img = document.createElement('img');
            img.src = APP_STATE.user.avatar;
            document.getElementById('userAvatar').appendChild(img);
        }

        function showAlert(modalId, message, type = 'error') {
            const alertDiv = document.getElementById(modalId === 'loginModal' ? 'loginAlert' : 'registerAlert');
            alertDiv.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // ===== GESTION DES COOKIES ET SESSION =====
        function setCookie(name, value, days = 30) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length));
            }
            return null;
        }

        function deleteCookie(name) {
            setCookie(name, "", -1);
        }

        function saveUserSession(email, password = null) {
            setCookie('pixendEmail', email, 30);
            if (password) {
                setCookie('pixendPassword', btoa(password), 30); // Base64 encoding (simple, pas sÃ©curisÃ© en prod)
            }
        }

        function loadUserSession() {
            const email = getCookie('pixendEmail');
            const password = getCookie('pixendPassword');
            
            if (email && password) {
                return { email, password: atob(password) };
            } else if (email) {
                return { email, password: null };
            }
            return null;
        }

        function clearUserSession() {
            deleteCookie('pixendEmail');
            deleteCookie('pixendPassword');
        }

        function handleGoogleSignIn(response, isRegister = false) {
            try {
                const token = response.credential;
                // DÃ©coder le JWT sans vÃ©rifier la signature (demo)
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                const email = payload.email;
                const name = payload.name;
                const picture = payload.picture;

                if (isRegister) {
                    // VÃ©rifier si l'email existe dÃ©jÃ 
                    if (APP_STATE.users[email]) {
                        showAlert('registerModal', 'Cet email est dÃ©jÃ  inscrit!', 'error');
                        return;
                    }

                    // CrÃ©er un nouvel utilisateur
                    const userData = {
                        id: 'user_' + email.replace(/[^a-zA-Z0-9]/g, ''),
                        username: name || email.split('@')[0],
                        displayName: name || email.split('@')[0],
                        email: email,
                        avatar: picture || generateDefaultAvatar(),
                        isAnonymous: false,
                        favoriteChannels: [],
                        googleAuth: true
                    };

                    APP_STATE.users[email] = userData;
                    saveUsers();
                    loginWithGoogle(userData, 'registerModal');
                } else {
                    // Connexion Google
                    if (APP_STATE.users[email]) {
                        const userData = APP_STATE.users[email];
                        loginWithGoogle(userData, 'loginModal');
                    } else {
                        showAlert('loginModal', 'Aucun compte trouvÃ©. Veuillez vous inscrire.', 'error');
                    }
                }
            } catch (error) {
                console.error('Erreur Google:', error);
                showAlert(isRegister ? 'registerModal' : 'loginModal', 'Erreur lors de la connexion Google', 'error');
            }
        }

        function loginWithGoogle(userData, modalId) {
            APP_STATE.user = userData;
            APP_STATE.isLoggedIn = true;
            document.getElementById('logoutBtn').style.display = 'block';
            updateUserDisplay();
            closeModal(modalId);
            hideWelcome();
            saveAppState();
            showAlert(modalId, 'Bienvenue ' + userData.displayName + '!', 'success');
            SOUNDS.connect?.();
            startRealTimeSync();
            initWebSocket();
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const rememberMe = document.getElementById('rememberMeCheckbox')?.checked || false;

            if (!email || !password) {
                showAlert('loginModal', 'Veuillez remplir tous les champs', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showAlert('loginModal', 'Email invalide', 'error');
                return;
            }

            const userData = APP_STATE.users[email];

            if (!userData) {
                showAlert('loginModal', 'Email ou mot de passe incorrect', 'error');
                return;
            }

            if (userData.password !== password) {
                showAlert('loginModal', 'Email ou mot de passe incorrect', 'error');
                return;
            }

            // Sauvegarder la session si "Se souvenir de moi" est cochÃ©
            if (rememberMe) {
                saveUserSession(email, password);
            } else {
                saveUserSession(email); // Sauvegarder seulement l'email
            }

            // Retirer l'utilisateur anonyme de la liste
            removeUserOnline(APP_STATE.user.id);
            
            APP_STATE.user = userData;
            APP_STATE.isLoggedIn = true;
            
            // V2: Initialize user presence
            if (!APP_STATE.userPresence[email]) {
                APP_STATE.userPresence[email] = {
                    status: 'online',
                    lastSeen: new Date().toISOString(),
                    currentServer: null
                };
            }
            
            // Ajouter l'utilisateur connectÃ© Ã  la liste
            addUserOnline(userData.id);
            
            // Mettre Ã  jour la prÃ©sence
            if (APP_STATE.currentServerId) {
                updateUserPresence(userData.email, APP_STATE.currentServerId, APP_STATE.currentChannelId, 'online');
            }
            
            document.getElementById('logoutBtn').style.display = 'block';
            updateUserDisplay();
            
            // V2: Afficher les serveurs aprÃ¨s connexion
            try {
                if (APP_STATE.servers && Object.keys(APP_STATE.servers).length > 0) {
                    renderServerSidebar();
                }
            } catch(e) {
                console.error('Erreur renderServerSidebar:', e);
            }
            
            closeModal('loginModal');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            hideWelcome();
            saveAppState();
            showAlert('loginModal', 'Bienvenue ' + userData.displayName + '!', 'success');
            SOUNDS.connect?.();
            startRealTimeSync();
            initWebSocket();
        }

        function registerUser() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value.trim();

            if (!username || !email || !password || !passwordConfirm) {
                showAlert('registerModal', 'Tous les champs sont requis', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showAlert('registerModal', 'Email invalide', 'error');
                return;
            }

            if (username.length < 3 || username.length > 20) {
                showAlert('registerModal', 'Le pseudo doit contenir entre 3 et 20 caractÃ¨res', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('registerModal', 'Le mot de passe doit contenir au moins 6 caractÃ¨res', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showAlert('registerModal', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }

            if (APP_STATE.users[email]) {
                showAlert('registerModal', 'Cet email est dÃ©jÃ  inscrit', 'error');
                return;
            }

            const userData = {
                id: 'user_' + email.replace(/[^a-zA-Z0-9]/g, ''),
                username: username,
                displayName: username,
                email: email,
                password: password,
                isAnonymous: false,
                avatar: generateDefaultAvatar(),
                favoriteChannels: [],
                googleAuth: false
            };

            APP_STATE.users[email] = userData;
            saveUsers();
            
            // Retirer l'utilisateur anonyme de la liste
            removeUserOnline(APP_STATE.user.id);
            
            APP_STATE.user = userData;
            APP_STATE.isLoggedIn = true;
            
            // Ajouter le nouvel utilisateur Ã  la liste
            addUserOnline(userData.id);
            
            document.getElementById('logoutBtn').style.display = 'block';
            updateUserDisplay();
            closeModal('registerModal');
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPasswordConfirm').value = '';
            hideWelcome();
            saveAppState();
            showAlert('registerModal', 'Compte crÃ©Ã© avec succÃ¨s!', 'success');
            SOUNDS.connect?.();
            startRealTimeSync();
            initWebSocket();
        }

        function logout() {
            // Retirer l'utilisateur courant de la liste
            removeUserOnline(APP_STATE.user.id);
            
            // Marquer comme offline
            if (APP_STATE.currentServerId) {
                if (!APP_STATE.servers[APP_STATE.currentServerId].onlineMembers) {
                    APP_STATE.servers[APP_STATE.currentServerId].onlineMembers = {};
                }
                APP_STATE.servers[APP_STATE.currentServerId].onlineMembers[APP_STATE.user.email] = {
                    status: 'offline',
                    lastSeen: new Date().toISOString()
                };
            }
            
            APP_STATE.user = generateAnonymousUser();
            APP_STATE.isLoggedIn = false;
            
            // Ajouter le nouvel utilisateur anonyme
            addUserOnline(APP_STATE.user.id);
            
            // Effacer la session
            clearUserSession();
            
            // ArrÃªter la synchronisation
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            document.getElementById('logoutBtn').style.display = 'none';
            updateUserDisplay();
            showWelcome();
            saveAppState();
        }

        // ===== SAUVEGARDE UTILISATEURS =====
        function saveUsers() {
            try {
                localStorage.setItem('pixendUsers', JSON.stringify(APP_STATE.users));
            } catch (e) {
                console.log('Impossible de sauvegarder les utilisateurs');
            }
        }

        // ===== GESTION DES MODALES =====
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            SOUNDS.click?.();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ===== GESTION DES IMAGES =====
        function setupImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');

                    const msg = {
                        username: APP_STATE.user.displayName,
                        userId: APP_STATE.user.id,
                        text: '[Image partagÃ©e]',
                        time: `${hours}:${minutes}`,
                        avatar: APP_STATE.user.avatar,
                        imageUrl: event.target.result
                    };

                    if (APP_STATE.privateChats[APP_STATE.currentChannel]) {
                        APP_STATE.privateChats[APP_STATE.currentChannel].messages.push(msg);
                    } else {
                        APP_STATE.channels[APP_STATE.currentChannel].messages.push(msg);
                    }

                    renderMessages();
                    SOUNDS.message?.();
                    document.getElementById('imageUpload').value = '';
                    saveAppState();
                };
                reader.readAsDataURL(file);
            });
        }

        // ===== SAUVEGARDE/RESTAURATION =====
        function saveAppState() {
            try {
                localStorage.setItem('pixendAppState', JSON.stringify(APP_STATE));
            } catch (e) {
                console.log('Impossible de sauvegarder');
            }
        }

        function loadAppState() {
            try {
                const saved = localStorage.getItem('pixendAppState');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    Object.assign(APP_STATE, loaded);
                }
            } catch (e) {
                console.log('Impossible de charger');
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Page d'accueil
            document.getElementById('continueAnonBtn').addEventListener('click', () => {
                hideWelcome();
                setupTypingIndicator();
                // Initialiser WebSocket pour les utilisateurs anonymes aussi
                if (!socket || !socket.connected) {
                    initWebSocket();
                }
            });

            document.getElementById('showLoginBtn').addEventListener('click', () => {
                switchWelcomeView('login');
            });

            document.getElementById('showRegisterBtn').addEventListener('click', () => {
                switchWelcomeView('register');
            });

            document.getElementById('welcomeLoginBackBtn').addEventListener('click', () => {
                switchWelcomeView('main');
            });

            document.getElementById('welcomeRegisterBackBtn').addEventListener('click', () => {
                switchWelcomeView('main');
            });

            document.getElementById('welcomeLoginSubmitBtn').addEventListener('click', welcomeLoginUser);
            document.getElementById('welcomeRegisterSubmitBtn').addEventListener('click', welcomeRegisterUser);

            // EntrÃ©e pour se connecter/inscrire
            document.getElementById('welcomeLoginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') welcomeLoginUser();
            });

            document.getElementById('welcomeRegisterPasswordConfirm').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') welcomeRegisterUser();
            });

            // Toggle mot de passe - Page d'accueil
            document.getElementById('welcomeLoginToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('welcomeLoginPassword');
            });

            document.getElementById('welcomeRegisterToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('welcomeRegisterPassword');
            });

            document.getElementById('welcomeRegisterConfirmToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('welcomeRegisterPasswordConfirm');
            });

            // Toggle mot de passe - Modales
            document.getElementById('loginToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('loginPassword');
            });

            document.getElementById('registerToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('registerPassword');
            });

            document.getElementById('registerConfirmToggle').addEventListener('click', (e) => {
                e.preventDefault();
                togglePasswordVisibility('registerPasswordConfirm');
            });

            // Bouton home
            document.getElementById('homeBtn').addEventListener('click', () => {
                showWelcome();
            });

            // Envoi de message
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Nouveau salon
            document.getElementById('newChannelBtn').addEventListener('click', () => openModal('newChannelModal'));
            document.getElementById('createChannelBtn').addEventListener('click', createChannel);
            document.getElementById('cancelChannelBtn').addEventListener('click', () => closeModal('newChannelModal'));

            // Connexion
            document.getElementById('loginSubmitBtn').addEventListener('click', loginUser);
            document.getElementById('loginCancelBtn').addEventListener('click', () => closeModal('loginModal'));
            document.getElementById('googleLoginBtn').addEventListener('click', () => {
                initGoogleSignIn(false);
            });

            // Inscription
            document.getElementById('registerSubmitBtn').addEventListener('click', registerUser);
            document.getElementById('registerCancelBtn').addEventListener('click', () => closeModal('registerModal'));
            document.getElementById('googleRegisterBtn').addEventListener('click', () => {
                initGoogleSignIn(true);
            });

            // DÃ©connexion
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Upload image
            document.getElementById('uploadImageBtn').addEventListener('click', () => {
                document.getElementById('imageUpload').click();
            });

            // Fermer modales avec Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
                    closeChannelMenu();
                    closeProfileModal();
                }
            });

            // Fermer le menu du salon si on clique en dehors
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('channelMenu');
                const btn = document.getElementById('channelMenuBtn');
                if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                    closeChannelMenu();
                }
            });

            // Setup image upload
            setupImageUpload();
        }

        // ===== DÃ‰MARRAGE =====
        let googleSignInMode = false;

        function initGoogleSignIn(isRegister) {
            googleSignInMode = isRegister;
            if (window.google && window.google.accounts) {
                window.google.accounts.id.renderButton(
                    isRegister ? document.getElementById('googleRegisterBtn') : document.getElementById('googleLoginBtn'),
                    { theme: 'outline', size: 'large', text: 'signin_with' }
                );
                
                // Trigger le sign-in
                window.google.accounts.id.prompt(() => {});
            }
        }

        // Callback pour Google Sign-In
        window.handleCredentialResponse = function(response) {
            if (googleSignInMode !== undefined) {
                handleGoogleSignIn(response, googleSignInMode);
            }
        };

        // ===== FONCTIONS PROFIL UTILISATEUR =====
        // ===== PAGE DE PROFIL COMPLÃˆTE =====
        function openProfilePage() {
            if (!APP_STATE.user) {
                alert('Vous devez Ãªtre connectÃ©!');
                return;
            }
            
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('profilePage').style.display = 'flex';
            document.getElementById('profilePage').classList.add('active');
            
            // Afficher les infos de l'utilisateur
            document.getElementById('profilePageAvatar').src = APP_STATE.user.avatar;
            document.getElementById('profileUsernameDisplay').textContent = APP_STATE.user.displayName || APP_STATE.user.username;
            document.getElementById('profileUserIdDisplay').textContent = '#' + (APP_STATE.user.id.substring(0, 4)).toUpperCase();
            
            const joinDate = APP_STATE.user.createdAt ? new Date(APP_STATE.user.createdAt) : new Date();
            document.getElementById('profileJoinDateDisplay').textContent = 'Inscrit le ' + joinDate.toLocaleDateString('fr-FR');
            
            // Afficher les boutons d'Ã©dition
            if (!APP_STATE.user.isAnonymous) {
                document.getElementById('changeAvatarBtn').style.display = 'block';
                document.getElementById('editUsernameBtn').style.display = 'block';
            }
            
            renderProfileRanks();
            renderProfileFavorites();
            renderProfileFriends();
            renderProfileServers();
        }

        function closeProfilePage() {
            document.getElementById('profilePage').classList.remove('active');
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }

        // ===== AFFICHER LES RANKS DE L'UTILISATEUR =====
        function renderProfileRanks() {
            const ranksList = document.getElementById('profileRanksList');
            ranksList.innerHTML = '';
            
            let hasRanks = false;
            
            // VÃ©rifier les ranks dans chaque serveur
            Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                if (server.members[APP_STATE.user.id]) {
                    const rankName = server.members[APP_STATE.user.id].rank;
                    if (rankName && rankName !== 'member') {
                        hasRanks = true;
                        const rank = RANKS[rankName];
                        const rankDiv = document.createElement('div');
                        rankDiv.className = 'profile-rank-item';
                        rankDiv.innerHTML = `<span style="color: ${rank.color};">${rank.symbol} ${rank.name}</span> du serveur "<strong>${server.name}</strong>"`;
                        ranksList.appendChild(rankDiv);
                    }
                }
            });
            
            if (!hasRanks) {
                ranksList.innerHTML = '<div style="color: var(--color-text-dim); font-size: 9px;">Aucun rank spÃ©cial</div>';
            }
        }

        // ===== AFFICHER LES FAVORIS =====
        function renderProfileFavorites() {
            const favoritesList = document.getElementById('profileFavoritesList');
            favoritesList.innerHTML = '';
            
            const favorites = APP_STATE.user.favoriteServers || [];
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur en favoris</div>';
                return;
            }
            
            favorites.forEach(serverId => {
                const server = APP_STATE.servers[serverId];
                if (server) {
                    const favDiv = document.createElement('div');
                    favDiv.className = 'profile-favorite-item';
                    favDiv.innerHTML = `
                        <div class="profile-item-info">
                            <div class="profile-item-name">ðŸ“Œ ${server.name}</div>
                            <div class="profile-item-status">${Object.keys(server.members).length} membres</div>
                        </div>
                        <div class="profile-item-actions">
                            <button class="btn-profile-item" onclick="goToServer('${serverId}')">Aller</button>
                            <button class="btn-profile-item" onclick="removeFavorite('${serverId}')">âŒ</button>
                        </div>
                    `;
                    favoritesList.appendChild(favDiv);
                }
            });
        }

        // ===== AFFICHER LES AMIS =====
        function renderProfileFriends() {
            const onlineList = document.getElementById('profileFriendsOnlineList');
            const allList = document.getElementById('profileFriendsAllList');
            onlineList.innerHTML = '';
            allList.innerHTML = '';
            
            const friends = getFriendsList(APP_STATE.user.id);
            const onlineFriends = [];
            const offlineFriends = [];
            
            friends.forEach(friend => {
                const status = getUserStatus(friend.id);
                if (status === 'online') {
                    onlineFriends.push(friend);
                } else {
                    offlineFriends.push(friend);
                }
            });
            
            if (onlineFriends.length === 0) {
                onlineList.innerHTML = '<div style="color: var(--color-text-dim); font-size: 9px;">Aucun ami en ligne</div>';
            } else {
                onlineFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'profile-friend-item';
                    const presence = APP_STATE.userPresence[friend.id];
                    let serverInfo = 'En ligne';
                    if (presence && presence.currentServerId) {
                        const server = APP_STATE.servers[presence.currentServerId];
                        if (server) serverInfo = 'Dans: ' + server.name;
                    }
                    
                    friendDiv.innerHTML = `
                        <div class="profile-item-info" onclick="visitUserProfile('${friend.id}')">
                            <div class="profile-item-name">ðŸ‘¤ ${friend.displayName}</div>
                            <div class="profile-item-status">ðŸŸ¢ ${serverInfo}</div>
                        </div>
                        <div class="profile-item-actions">
                            <button class="btn-profile-item" onclick="goToFriendServer('${friend.id}')">Rejoindre</button>
                            <button class="btn-profile-item" onclick="sendDMToFriend('${friend.id}')">ðŸ’¬</button>
                        </div>
                    `;
                    onlineList.appendChild(friendDiv);
                });
            }
            
            if (offlineFriends.length === 0) {
                allList.innerHTML = '<div style="color: var(--color-text-dim); font-size: 9px;">Aucun autre ami</div>';
            } else {
                offlineFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'profile-friend-item';
                    friendDiv.innerHTML = `
                        <div class="profile-item-info" onclick="visitUserProfile('${friend.id}')">
                            <div class="profile-item-name">ðŸ‘¤ ${friend.displayName}</div>
                            <div class="profile-item-status">âšª Hors ligne</div>
                        </div>
                        <div class="profile-item-actions">
                            <button class="btn-profile-item" onclick="sendDMToFriend('${friend.id}')">ðŸ’¬</button>
                        </div>
                    `;
                    allList.appendChild(friendDiv);
                });
            }
        }

        // ===== AFFICHER LES SERVEURS =====
        function renderProfileServers() {
            const serversList = document.getElementById('profileServersList');
            serversList.innerHTML = '';
            
            let userServers = [];
            Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                if (server.members[APP_STATE.user.id]) {
                    userServers.push({id: serverId, ...server});
                }
            });
            
            if (userServers.length === 0) {
                serversList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur</div>';
                return;
            }
            
            userServers.forEach(server => {
                const rankName = server.members[APP_STATE.user.id].rank;
                const rank = RANKS[rankName];
                const isFavorite = (APP_STATE.user.favoriteServers || []).includes(server.id);
                
                const serverDiv = document.createElement('div');
                serverDiv.className = 'profile-server-item';
                serverDiv.innerHTML = `
                    <div class="profile-item-info">
                        <div class="profile-item-name">ðŸ“Œ ${server.name}</div>
                        <div class="profile-item-status"><span style="color: ${rank.color};">${rank.symbol} ${rank.name}</span></div>
                    </div>
                    <div class="profile-item-actions">
                        <button class="btn-profile-item" onclick="toggleFavorite('${server.id}')">${isFavorite ? 'â­' : 'â˜†'}</button>
                        <button class="btn-profile-item" onclick="goToServer('${server.id}')">Aller</button>
                    </div>
                `;
                serversList.appendChild(serverDiv);
            });
        }

        // ===== GÃ‰RER LES FAVORIS =====
        function toggleFavorite(serverId) {
            if (!APP_STATE.user.favoriteServers) {
                APP_STATE.user.favoriteServers = [];
            }
            
            const index = APP_STATE.user.favoriteServers.indexOf(serverId);
            if (index > -1) {
                APP_STATE.user.favoriteServers.splice(index, 1);
            } else {
                APP_STATE.user.favoriteServers.push(serverId);
            }
            
            saveAppState();
            renderProfileServers();
        }

        function removeFavorite(serverId) {
            toggleFavorite(serverId);
            renderProfileFavorites();
        }

        // ===== NAVIGUER AUX SERVEURS =====
        function goToServer(serverId) {
            if (APP_STATE.servers[serverId]) {
                closeProfilePage();
                APP_STATE.currentServerId = serverId;
                const firstChannelId = Object.keys(APP_STATE.servers[serverId].channels)[0];
                if (firstChannelId) {
                    APP_STATE.currentChannelId = firstChannelId;
                    updateChatArea();
                    renderChannels();
                }
            }
        }

        // ===== VISITER LE PROFIL D'UN AUTRE UTILISATEUR =====
        function visitUserProfile(userId) {
            const user = APP_STATE.users[Object.keys(APP_STATE.users).find(key => APP_STATE.users[key].id === userId)];
            if (!user) return;
            
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('otherProfilePage').style.display = 'flex';
            document.getElementById('otherProfilePage').classList.add('active');
            
            // Afficher les infos de l'utilisateur
            document.getElementById('otherProfileAvatar').src = user.avatar;
            document.getElementById('otherProfileUsername').textContent = user.displayName || user.username;
            document.getElementById('otherProfileUserId').textContent = '#' + (user.id.substring(0, 4)).toUpperCase();
            
            const joinDate = user.createdAt ? new Date(user.createdAt) : new Date();
            document.getElementById('otherProfileJoinDate').textContent = 'Inscrit le ' + joinDate.toLocaleDateString('fr-FR');
            
            // GÃ©rer le bouton "Ajouter en ami"
            const addFriendBtn = document.getElementById('addFriendBtn');
            if (user.isAnonymous) {
                addFriendBtn.style.display = 'none';
            } else {
                addFriendBtn.style.display = 'block';
                addFriendBtn.onclick = () => addFriendProfile(userId);
            }
            
            renderOtherUserRanks(userId);
            renderOtherUserFriends(userId);
            renderOtherUserServers(userId);
        }

        function closeOtherProfilePage() {
            document.getElementById('otherProfilePage').classList.remove('active');
            document.getElementById('otherProfilePage').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }

        // ===== AFFICHER LES INFOS D'UN AUTRE UTILISATEUR =====
        function renderOtherUserRanks(userId) {
            const ranksList = document.getElementById('otherProfileRanksList');
            ranksList.innerHTML = '';
            
            let hasRanks = false;
            Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                if (server.members[userId]) {
                    const rankName = server.members[userId].rank;
                    if (rankName && rankName !== 'member') {
                        hasRanks = true;
                        const rank = RANKS[rankName];
                        const rankDiv = document.createElement('div');
                        rankDiv.className = 'profile-rank-item';
                        rankDiv.innerHTML = `<span style="color: ${rank.color};">${rank.symbol} ${rank.name}</span> du serveur "<strong>${server.name}</strong>"`;
                        ranksList.appendChild(rankDiv);
                    }
                }
            });
            
            if (!hasRanks) {
                ranksList.innerHTML = '<div style="color: var(--color-text-dim); font-size: 9px;">Aucun rank spÃ©cial</div>';
            }
        }

        function renderOtherUserServers(userId) {
            const serversList = document.getElementById('otherProfileServersList');
            serversList.innerHTML = '';
            
            let userServers = [];
            Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                if (server.members[userId]) {
                    userServers.push({id: serverId, ...server});
                }
            });
            
            if (userServers.length === 0) {
                serversList.innerHTML = '<div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur</div>';
                return;
            }
            
            userServers.forEach(server => {
                const rankName = server.members[userId].rank;
                const rank = RANKS[rankName];
                
                const serverDiv = document.createElement('div');
                serverDiv.className = 'profile-server-item';
                serverDiv.innerHTML = `
                    <div class="profile-item-info">
                        <div class="profile-item-name">ðŸ“Œ ${server.name}</div>
                        <div class="profile-item-status"><span style="color: ${rank.color};">${rank.symbol} ${rank.name}</span></div>
                    </div>
                `;
                serversList.appendChild(serverDiv);
            });
        }

        function renderOtherUserFriends(userId) {
            const friendsList = document.getElementById('otherProfileFriendsList');
            friendsList.innerHTML = '';
            
            const friends = getFriendsList(userId);
            if (friends.length === 0) {
                friendsList.innerHTML = '<div style="color: var(--color-text-dim); font-size: 9px;">Aucun ami</div>';
                return;
            }
            
            friends.slice(0, 10).forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'profile-friend-item';
                friendDiv.innerHTML = `
                    <div class="profile-item-name">ðŸ‘¤ ${friend.displayName}</div>
                `;
                friendsList.appendChild(friendDiv);
            });
        }

        // ===== ONGLETS DU PROFIL =====
        function switchProfileTab(tabName) {
            document.querySelectorAll('#profileTab-' + tabName).forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            
            const tabs = document.querySelectorAll('[id^="profileTab-"]');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const content = document.getElementById('profileTab-' + tabName);
            if (content) content.classList.add('active');
            
            event.target.classList.add('active');
        }

        // ===== CONTACT & AMIS =====
        function contactUser() {
            closeOtherProfilePage();
            // CrÃ©er un DM avec cet utilisateur
            alert('DM ouvert avec cet utilisateur!');
        }

        function addCurrentUserFriend() {
            alert('Demande d\'ami envoyÃ©e!');
        }

        function addFriendProfile(userId) {
            addFriend(APP_STATE.user.id, userId);
            alert('Demande d\'ami envoyÃ©e!');
        }

        function sendDMToFriend(friendId) {
            APP_STATE.currentDMUserId = friendId;
            closeProfilePage();
            updateChatArea();
            renderChannels();
        }

        function goToFriendServer(friendId) {
            const presence = APP_STATE.userPresence[friendId];
            if (presence && presence.currentServerId) {
                goToServer(presence.currentServerId);
            } else {
                alert('Cet ami n\'est pas en ligne');
            }
        }

        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            if (!APP_STATE.user) return;

            // Remplir les informations du profil
            document.getElementById('profileUsername').textContent = APP_STATE.user.displayName || APP_STATE.user.username;
            document.getElementById('profileUserId').textContent = '#' + (APP_STATE.user.id.substring(0, 4)).toUpperCase();
            document.getElementById('profileAvatar').src = APP_STATE.user.avatar;
            document.getElementById('profileDisplayName').textContent = APP_STATE.user.displayName || APP_STATE.user.username;
            document.getElementById('profileJoinDate').textContent = new Date().toLocaleDateString('fr-FR');
            
            if (APP_STATE.user.email) {
                document.getElementById('emailSection').style.display = 'block';
                document.getElementById('profileEmail').textContent = APP_STATE.user.email;
            } else {
                document.getElementById('emailSection').style.display = 'none';
            }

            modal.classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function editProfile() {
            alert('Ã‰dition du profil : Cette fonctionnalitÃ© sera disponible prochainement!');
        }

        function logoutProfile() {
            closeProfileModal();
            logout();
        }

        // ===== MENU DU SALON =====
        function toggleChannelMenu() {
            const menu = document.getElementById('channelMenu');
            menu.classList.toggle('open');
            if (menu.classList.contains('open')) {
                updateChannelMenu();
            }
        }

        function closeChannelMenu() {
            document.getElementById('channelMenu').classList.remove('open');
        }

        function updateChannelMenu() {
            const currentChannel = APP_STATE.currentChannel;
            const channel = APP_STATE.channels[currentChannel];
            
            if (!channel) return;

            // Mettre Ã  jour le titre et les infos
            document.getElementById('menuChannelName').textContent = currentChannel.toUpperCase();
            document.getElementById('menuChannelInfo').textContent = 'CrÃ©Ã© par ' + (channel.createdBy || 'systÃ¨me');
            
            // Afficher SEULEMENT les utilisateurs prÃ©sents dans CE salon
            const usersInChannel = APP_STATE.activeChannelUsers[currentChannel] || [];
            const onlineUsers = [];
            
            // Ajouter les utilisateurs du salon courant
            usersInChannel.forEach(userId => {
                if (userId === APP_STATE.user?.id) {
                    // L'utilisateur courant en premier
                    onlineUsers.unshift({
                        name: APP_STATE.user.displayName || APP_STATE.user.username,
                        isCurrentUser: true
                    });
                } else {
                    // Chercher l'utilisateur dans la base de donnÃ©es
                    const userEmail = Object.keys(APP_STATE.users).find(email => {
                        const userData = APP_STATE.users[email];
                        return userData.id === userId;
                    });
                    if (userEmail) {
                        onlineUsers.push({
                            name: APP_STATE.users[userEmail].displayName || APP_STATE.users[userEmail].username,
                            isCurrentUser: false
                        });
                    }
                }
            });

            // Afficher les utilisateurs du salon
            const list = document.getElementById('onlineUsersList');
            list.innerHTML = '<div class="channel-menu-label" style="margin-bottom: 12px;"><span class="online-count">â¬¤ ' + onlineUsers.length + ' dans le salon</span></div>';
            onlineUsers.forEach(user => {
                list.innerHTML += `<div class="online-user"><span class="online-indicator"></span><span>${user.name}</span></div>`;
            });
        }

        // ===== EMOJI PICKER =====
        const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ¤”', 'ðŸ˜Ž', 'ðŸ”¥', 'ðŸ’¯', 'ðŸ‘', 'ðŸ‘Œ', 'âœŒï¸', 'ðŸ’ª', 'ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽˆ', 'ðŸŽ', 'â­', 'ðŸŒŸ', 'âœ¨', 'ðŸ’«', 'ðŸŒˆ', 'ðŸ’–', 'ðŸ’', 'ðŸ’¢', 'ðŸ’¥', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ»', 'ðŸŒ·', 'ðŸŒ¹', 'ðŸŽ®', 'ðŸŽ¯', 'ðŸŽ²'];

        function initEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            emojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.textContent = emoji;
                item.addEventListener('click', () => {
                    const input = document.getElementById('messageInput');
                    input.value += emoji;
                    input.focus();
                    closeEmojiPicker();
                });
                picker.appendChild(item);
            });

            // Toggle emoji picker
            document.getElementById('emojiPickerBtn').addEventListener('click', (e) => {
                e.preventDefault();
                toggleEmojiPicker();
            });

            // Fermer quand on clique ailleurs
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('emojiPicker');
                const btn = document.getElementById('emojiPickerBtn');
                if (!picker.contains(e.target) && !btn.contains(e.target)) {
                    closeEmojiPicker();
                }
            });
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const btn = document.getElementById('emojiPickerBtn');
            picker.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function closeEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const btn = document.getElementById('emojiPickerBtn');
            picker.classList.remove('active');
            btn.classList.remove('active');
        }

        // ===== PIXEND V2 FUNCTIONS =====

        // Core functions
        function createServer(name, description, rules, isPublic = true) {
            if (!APP_STATE.isLoggedIn) {
                alert('âŒ Vous devez Ãªtre connectÃ© pour crÃ©er un serveur!');
                return null;
            }
            const serverId = 'server_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const generalChannelId = 'chan_' + serverId + '_general';
            
            APP_STATE.servers[serverId] = {
                id: serverId,
                name: name,
                description: description,
                rules: rules,
                isPublic: isPublic,
                createdBy: APP_STATE.user.email,
                createdAt: new Date().toISOString(),
                members: [APP_STATE.user.email],
                ranks: { [APP_STATE.user.email]: 'admin' },
                guardians: [],
                channels: {
                    [generalChannelId]: {
                        id: generalChannelId,
                        serverId: serverId,
                        name: '> gÃ©nÃ©ral ' + name,
                        description: 'Salon principal du serveur',
                        rules: rules,
                        messages: [],
                        createdBy: APP_STATE.user.email,
                        guardians: []
                    }
                },
                joinRequests: [],
                bannedUsers: [], // { userId, until, reason }
                settings: {
                    requireApproval: !isPublic,
                    allowInvites: true
                }
            };
            
            saveAppState();
            return serverId;
        }

        function createChannel(serverId, name, description, rules = '') {
            if (!APP_STATE.isLoggedIn) {
                alert('âŒ Vous devez Ãªtre connectÃ©!');
                return null;
            }
            if (!APP_STATE.servers[serverId]) return null;
            if (APP_STATE.servers[serverId].ranks[APP_STATE.user.email] !== 'admin') {
                alert('âŒ Seul l\'admin peut crÃ©er des salons!');
                return null;
            }
            
            const channelId = 'chan_' + serverId + '_' + Date.now();
            APP_STATE.servers[serverId].channels[channelId] = {
                id: channelId,
                serverId: serverId,
                name: name,
                description: description,
                rules: rules,
                messages: [],
                createdBy: APP_STATE.user.email,
                guardians: []
            };
            
            saveAppState();
            return channelId;
        }

        function getUserRank(userId, serverId, channelId = null) {
            const server = APP_STATE.servers[serverId];
            if (!server) return 'user';
            
            const rank = server.ranks[userId] || 'user';
            
            if (channelId) {
                const channel = server.channels[channelId];
                if (channel && channel.guardians.includes(userId)) {
                    return rank === 'admin' ? 'admin' : 'guardian';
                }
            }
            
            return rank;
        }

        function getRankColor(rank) {
            const colors = {
                'admin': '#0080ff',
                'guardian': '#ff0000',
                'user': '#808080'
            };
            return colors[rank] || '#808080';
        }

        function getRankLabel(rank) {
            const labels = {
                'admin': 'ADMIN',
                'guardian': 'GUARDIAN',
                'user': 'USER'
            };
            return labels[rank] || 'USER';
        }

        function isServerAdmin(userId, serverId) {
            const server = APP_STATE.servers[serverId];
            return server && server.ranks[userId] === 'admin';
        }

        function isChannelGuardian(userId, serverId, channelId) {
            const server = APP_STATE.servers[serverId];
            if (!server) return false;
            const channel = server.channels[channelId];
            return channel && (channel.guardians.includes(userId) || server.ranks[userId] === 'admin');
        }

        // Friends management
        function addFriend(userId) {
            if (!APP_STATE.isLoggedIn) return false;
            if (APP_STATE.friends[userId]) return false;
            
            APP_STATE.friends[userId] = {
                status: 'pending',
                requestedBy: APP_STATE.user.email,
                addedAt: new Date().toISOString()
            };
            
            saveAppState();
            return true;
        }

        function acceptFriend(userId) {
            if (!APP_STATE.friends[userId]) return false;
            APP_STATE.friends[userId].status = 'accepted';
            saveAppState();
            return true;
        }

        function blockUser(userId) {
            if (APP_STATE.blocked.includes(userId)) return false;
            APP_STATE.blocked.push(userId);
            saveAppState();
            return true;
        }

        function isUserBlocked(userId) {
            return APP_STATE.blocked.includes(userId);
        }

        // DM functions
        function getOrCreateDM(friendUserId) {
            if (!APP_STATE.isLoggedIn) return null;
            if (!APP_STATE.directMessages[friendUserId]) {
                APP_STATE.directMessages[friendUserId] = [];
            }
            return APP_STATE.directMessages[friendUserId];
        }

        function sendPrivateMessage(toUserId, content) {
            if (!APP_STATE.isLoggedIn) return false;
            if (isUserBlocked(toUserId)) {
                alert('âŒ Vous avez bloquÃ© cet utilisateur!');
                return false;
            }
            
            const dm = getOrCreateDM(toUserId);
            dm.push({
                from: APP_STATE.user.email,
                to: toUserId,
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            saveAppState();
            return true;
        }

        // Moderation functions
        function warnUser(serverId, channelId, targetUserEmail, reason) {
            if (!isChannelGuardian(APP_STATE.user.email, serverId, channelId)) {
                alert('âŒ Vous n\'Ãªtes pas gardien de ce salon!');
                return false;
            }
            
            if (!APP_STATE.warnings[serverId]) {
                APP_STATE.warnings[serverId] = {};
            }
            if (!APP_STATE.warnings[serverId][targetUserEmail]) {
                APP_STATE.warnings[serverId][targetUserEmail] = [];
            }
            
            APP_STATE.warnings[serverId][targetUserEmail].push({
                reason: reason,
                timestamp: new Date().toISOString(),
                givenBy: APP_STATE.user.email
            });
            
            saveAppState();
            return true;
        }

        function banUserFromChannel(serverId, channelId, targetUserEmail, durationMinutes, reason) {
            if (!isChannelGuardian(APP_STATE.user.email, serverId, channelId)) {
                alert('âŒ Vous n\'Ãªtes pas gardien!');
                return false;
            }
            
            const server = APP_STATE.servers[serverId];
            if (!server) return false;
            
            const banUntil = new Date(Date.now() + durationMinutes * 60 * 1000).toISOString();
            
            if (!APP_STATE.bans[serverId]) APP_STATE.bans[serverId] = {};
            if (!APP_STATE.bans[serverId][channelId]) APP_STATE.bans[serverId][channelId] = [];
            
            APP_STATE.bans[serverId][channelId].push({
                userId: targetUserEmail,
                until: banUntil,
                reason: reason,
                type: 'temporary',
                bannedBy: APP_STATE.user.email,
                bannedAt: new Date().toISOString()
            });
            
            saveAppState();
            return true;
        }

        function banUserFromServer(serverId, targetUserEmail, durationDays, reason, formData = {}) {
            if (!isServerAdmin(APP_STATE.user.email, serverId)) {
                alert('âŒ Seul l\'admin du serveur peut faire Ã§a!');
                return false;
            }
            
            const server = APP_STATE.servers[serverId];
            if (!server) return false;
            
            const banUntil = new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000).toISOString();
            
            if (!APP_STATE.bans[serverId]) APP_STATE.bans[serverId] = {};
            if (!APP_STATE.bans[serverId].server) APP_STATE.bans[serverId].server = [];
            
            APP_STATE.bans[serverId].server.push({
                userId: targetUserEmail,
                until: banUntil,
                reason: reason,
                type: 'long-term',
                bannedBy: APP_STATE.user.email,
                bannedAt: new Date().toISOString(),
                formData: formData,
                documentation: formData.documentation || ''
            });
            
            // Remove from members
            const idx = server.members.indexOf(targetUserEmail);
            if (idx > -1) server.members.splice(idx, 1);
            
            saveAppState();
            return true;
        }

        function isUserBannedFromChannel(userId, serverId, channelId) {
            const bans = APP_STATE.bans[serverId]?.[channelId] || [];
            const now = new Date();
            
            for (let ban of bans) {
                if (ban.userId === userId && new Date(ban.until) > now) {
                    return true;
                }
            }
            return false;
        }

        function isUserBannedFromServer(userId, serverId) {
            const bans = APP_STATE.bans[serverId]?.server || [];
            const now = new Date();
            
            for (let ban of bans) {
                if (ban.userId === userId && new Date(ban.until) > now) {
                    return true;
                }
            }
            return false;
        }

        function promoteToGuardian(serverId, channelId, targetUserEmail) {
            if (!isServerAdmin(APP_STATE.user.email, serverId)) {
                alert('âŒ Seul l\'admin peut promouvoir!');
                return false;
            }
            
            const server = APP_STATE.servers[serverId];
            const channel = server.channels[channelId];
            if (!channel) return false;
            
            if (channel.guardians.length >= 6) {
                alert('âŒ Max 6 gardiens par salon!');
                return false;
            }
            
            if (!channel.guardians.includes(targetUserEmail)) {
                channel.guardians.push(targetUserEmail);
            }
            
            saveAppState();
            return true;
        }

        function joinServer(serverId) {
            if (!APP_STATE.isLoggedIn) {
                alert('âŒ Vous devez Ãªtre connectÃ©!');
                return false;
            }
            
            const server = APP_STATE.servers[serverId];
            if (!server) return false;
            
            if (server.members.includes(APP_STATE.user.email)) {
                alert('âŒ Vous Ãªtes dÃ©jÃ  dans ce serveur!');
                return false;
            }
            
            if (server.isPublic) {
                server.members.push(APP_STATE.user.email);
                server.ranks[APP_STATE.user.email] = 'user';
                saveAppState();
                return true;
            } else {
                // Request to join
                if (!server.joinRequests.includes(APP_STATE.user.email)) {
                    server.joinRequests.push(APP_STATE.user.email);
                }
                saveAppState();
                alert('âœ… Demande envoyÃ©e! En attente d\'approbation.');
                return false;
            }
        }

        function getServerMembers(serverId) {
            const server = APP_STATE.servers[serverId];
            if (!server) return [];
            
            return server.members.map(email => ({
                email: email,
                rank: server.ranks[email],
                user: APP_STATE.users[email]
            }));
        }

        // Persistence
        function saveAppState() {
            localStorage.setItem('pixendAppState', JSON.stringify(APP_STATE));
        }

        function loadAppState() {
            const saved = localStorage.getItem('pixendAppState');
            if (saved) {
                const loaded = JSON.parse(saved);
                Object.assign(APP_STATE, loaded);
            }
        }

        // V2 Modales
        function openNewServerModal() {
            if (!APP_STATE.isLoggedIn) {
                alert('âŒ Vous devez Ãªtre connectÃ© pour crÃ©er un serveur!');
                return;
            }
            const modal = document.getElementById('newServerModal');
            modal.style.display = 'flex';
        }

        function closeServerModal() {
            const modal = document.getElementById('newServerModal');
            modal.style.display = 'none';
        }

        function createServerFromModal() {
            const name = document.getElementById('serverNameInput').value.trim();
            const desc = document.getElementById('serverDescInput').value.trim();
            const rules = document.getElementById('serverRulesInput').value.trim();
            const isPublic = document.getElementById('serverPublicToggle').checked;

            if (!name) {
                alert('âŒ Le nom du serveur est obligatoire!');
                return;
            }

            if (!rules) {
                alert('âŒ Les rÃ¨gles du serveur sont obligatoires!');
                return;
            }

            const serverId = 'server_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const generalChannelId = 'chan_' + serverId + '_general';

            const serverData = {
                id: serverId,
                name: name,
                description: desc,
                rules: rules,
                isPublic: isPublic,
                createdBy: APP_STATE.user.email,
                createdAt: new Date().toISOString(),
                members: [APP_STATE.user.email],
                ranks: { [APP_STATE.user.email]: 'admin' },
                channels: {
                    [generalChannelId]: {
                        id: generalChannelId,
                        serverId: serverId,
                        name: '> gÃ©nÃ©ral ' + name,
                        description: 'Salon principal du serveur',
                        rules: rules,
                        messages: [],
                        createdBy: APP_STATE.user.email,
                        guardians: []
                    }
                },
                joinRequests: [],
                bannedUsers: [],
                settings: {
                    requireApproval: !isPublic,
                    allowInvites: true
                }
            };

            APP_STATE.servers[serverId] = serverData;

            // Envoyer via WebSocket si connectÃ©
            if (socket && socket.connected) {
                socket.emit('server:create', {
                    serverId: serverId,
                    name: name,
                    description: desc,
                    rules: rules,
                    isPublic: isPublic,
                    createdBy: APP_STATE.user.email
                });
                console.log('ðŸ“¤ Serveur crÃ©Ã© via WebSocket');
            }

            alert(`âœ… Serveur "${name}" crÃ©Ã©!`);
            document.getElementById('serverNameInput').value = '';
            document.getElementById('serverDescInput').value = '';
            document.getElementById('serverRulesInput').value = '';
            closeServerModal();
            renderServerSidebar();
            selectServerV2(serverId);
            saveAppState();
        }

        // UI Rendering V2
        function renderServerSidebar() {
            const sidebar = document.getElementById('channelsList');
            if (!sidebar) {
                console.error('âŒ Erreur: #channelsList introuvable!');
                return;
            }
            
            sidebar.innerHTML = '';
            
            // Servers section
            const serverSection = document.createElement('div');
            serverSection.className = 'sidebar-section';
            serverSection.innerHTML = '<div style="color: var(--color-primary); font-weight: bold; padding: 8px; margin-bottom: 8px;">ðŸ“¦ SERVEURS</div>';
            
            Object.entries(APP_STATE.servers).forEach(([serverId, server]) => {
                if (!server.members.includes(APP_STATE.user?.email || 'anon')) return;
                
                const serverDiv = document.createElement('div');
                serverDiv.className = 'server-container';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'server-header';
                headerDiv.innerHTML = `${server.name}`;
                headerDiv.style.cursor = 'pointer';
                headerDiv.onclick = () => selectServerV2(serverId);
                
                serverDiv.appendChild(headerDiv);
                
                // Channels in server
                Object.entries(server.channels).forEach(([channelId, channel]) => {
                    const channelDiv = document.createElement('div');
                    channelDiv.className = 'channel-item';
                    if (APP_STATE.currentChannelId === channelId) {
                        channelDiv.classList.add('active');
                    }
                    
                    const rank = getUserRank(APP_STATE.user?.email || 'anon', serverId, channelId);
                    channelDiv.innerHTML = `
                        <span>${channel.name}</span>
                        <span class="rank-badge ${rank}">${getRankLabel(rank)}</span>
                    `;
                    channelDiv.onclick = () => selectChannelV2(serverId, channelId);
                    serverDiv.appendChild(channelDiv);
                });
                
                serverSection.appendChild(serverDiv);
            });
            
            sidebar.appendChild(serverSection);
        }

        function selectServerV2(serverId) {
            APP_STATE.currentServerId = serverId;
            const server = APP_STATE.servers[serverId];
            if (server) {
                const firstChannel = Object.keys(server.channels)[0];
                selectChannelV2(serverId, firstChannel);
            }
        }

        function selectChannelV2(serverId, channelId) {
            APP_STATE.currentServerId = serverId;
            APP_STATE.currentChannelId = channelId;
            
            // Marquer l'utilisateur comme en ligne dans ce serveur/canal
            if (APP_STATE.isLoggedIn) {
                updateUserPresence(APP_STATE.user.email, serverId, channelId, 'online');
            }
            
            // Rejoindre le canal via WebSocket
            if (socket && socket.connected) {
                socket.emit('server:join', {
                    serverId: serverId,
                    channelId: channelId,
                    userEmail: APP_STATE.user.email || APP_STATE.user.id
                });
                console.log('ðŸ“¥ Rejoint le canal:', channelId);
            }
            
            renderServerSidebar();
            renderChatArea();
        }

        function renderChatArea() {
            const server = APP_STATE.servers[APP_STATE.currentServerId];
            const channel = server?.channels[APP_STATE.currentChannelId];
            
            if (!channel) {
                // Fallback to old rendering system
                renderMessages();
                return;
            }
            
            const chatArea = document.getElementById('messagesContainer');
            if (!chatArea) {
                console.error('âŒ Erreur: #messagesContainer introuvable!');
                return;
            }
            
            chatArea.innerHTML = '';
            
            // Rules header
            if (channel.rules) {
                const rulesDiv = document.createElement('div');
                rulesDiv.style.cssText = 'padding: 12px; background: rgba(255,0,110,0.2); border-left: 3px solid var(--color-primary); margin-bottom: 12px; font-size: 10px;';
                rulesDiv.innerHTML = `<strong>ðŸ“‹ RÃ¨gles:</strong> ${channel.rules}`;
                chatArea.appendChild(rulesDiv);
            }
            
            // Messages
            if (channel.messages.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'text-align: center; color: var(--color-text-dim); padding: 20px;';
                emptyDiv.textContent = 'Aucun message pour le moment...';
                chatArea.appendChild(emptyDiv);
            } else {
                channel.messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    msgDiv.style.cssText = 'padding: 8px; margin: 8px 0; background: var(--color-bg-tertiary); border-left: 2px solid var(--color-accent); display: flex; gap: 8px;';
                    
                    // Avatar
                    const avatarDiv = document.createElement('div');
                    avatarDiv.style.cssText = 'width: 32px; height: 32px; border-radius: 2px; background: var(--color-border); flex-shrink: 0; image-rendering: pixelated;';
                    if (msg.avatar) {
                        const img = document.createElement('img');
                        img.src = msg.avatar;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                        avatarDiv.appendChild(img);
                    } else {
                        avatarDiv.textContent = 'ðŸ‘¤';
                        avatarDiv.style.cssText += ' display: flex; align-items: center; justify-content: center;';
                    }
                    msgDiv.appendChild(avatarDiv);
                    
                    // Content
                    const contentDiv = document.createElement('div');
                    contentDiv.style.cssText = 'flex: 1;';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; gap: 8px;';
                    
                    const authorSpan = document.createElement('strong');
                    authorSpan.textContent = msg.displayName || msg.author || 'Utilisateur';
                    authorSpan.style.cssText = 'color: var(--color-primary);';
                    headerDiv.appendChild(authorSpan);
                    
                    const rank = getUserRank(msg.author, APP_STATE.currentServerId, APP_STATE.currentChannelId);
                    const rankSpan = document.createElement('span');
                    rankSpan.className = `rank-badge ${rank}`;
                    rankSpan.textContent = getRankLabel(rank);
                    rankSpan.style.cssText = `font-size: 8px; padding: 2px 6px;`;
                    headerDiv.appendChild(rankSpan);
                    
                    contentDiv.appendChild(headerDiv);
                    
                    const textDiv = document.createElement('div');
                    textDiv.textContent = msg.content;
                    textDiv.style.cssText = 'color: var(--color-text); font-size: 11px; word-wrap: break-word;';
                    contentDiv.appendChild(textDiv);
                    
                    const timeDiv = document.createElement('div');
                    timeDiv.style.cssText = 'font-size: 8px; color: var(--color-text-dim); margin-top: 4px;';
                    timeDiv.textContent = new Date(msg.timestamp).toLocaleString('fr-FR');
                    contentDiv.appendChild(timeDiv);
                    
                    msgDiv.appendChild(contentDiv);
                    chatArea.appendChild(msgDiv);
                });
            }
            
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function sendMessageToChannel(content) {
            if (!APP_STATE.currentServerId || !APP_STATE.currentChannelId) {
                alert('âŒ SÃ©lectionnez un canal!');
                return;
            }
            
            const server = APP_STATE.servers[APP_STATE.currentServerId];
            const channel = server?.channels[APP_STATE.currentChannelId];
            
            if (!channel) return;
            
            // VÃ©rifier si c'est un anonyme et s'il essaie d'envoyer dans un canal autre que gÃ©nÃ©ral
            const channelName = channel.name.toLowerCase();
            const isGeneralChannel = channelName.includes('gÃ©nÃ©ral') || channelName.includes('general');
            
            if (!APP_STATE.isLoggedIn && !isGeneralChannel) {
                alert('âŒ Vous devez Ãªtre connectÃ© pour envoyer des messages ici!');
                return;
            }
            
            const message = {
                id: 'msg_' + Date.now(),
                author: APP_STATE.user.email,
                content: content,
                timestamp: new Date().toISOString(),
                avatar: APP_STATE.user.avatar,
                displayName: APP_STATE.user.displayName || APP_STATE.user.id,
                serverId: APP_STATE.currentServerId,
                channelId: APP_STATE.currentChannelId
            };
            
            // Ajouter localement
            channel.messages.push(message);
            
            // Envoyer via WebSocket si connectÃ©
            if (socket && socket.connected) {
                socket.emit('message:send', message);
                console.log('ðŸ“¤ Message envoyÃ© via WebSocket');
            } else {
                console.log('ðŸ“ Message sauvegardÃ© localement (WebSocket non connectÃ©)');
            }
            
            // Sauvegarder
            saveAppState();
            
            // Re-rendre
            renderChatArea();
            
            // Scroller en bas
            const chatArea = document.getElementById('messagesContainer');
            if (chatArea) {
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 50);
            }
        }

        // ===== WEBSOCKET CONNECTION =====
        let socket = null;

        function initWebSocket() {
            try {
                // Utiliser la configuration automatique
                const config = window.PIXEND_CONFIG || getServerConfig();
                const socketUrl = config.serverUrl;
                
                console.log(`ðŸ“¡ Connexion au serveur: ${socketUrl}`);
                
                socket = io(socketUrl, {
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    reconnectionAttempts: 5
                });

                socket.on('connect', () => {
                    console.log('âœ… ConnectÃ© au serveur WebSocket');

                    // Envoyer l'authentification
                    if (APP_STATE.isLoggedIn) {
                        socket.emit('user:auth', {
                            email: APP_STATE.user.email,
                            displayName: APP_STATE.user.displayName,
                            avatar: APP_STATE.user.avatar
                        });
                    }

                    // Rejoindre automatiquement le canal courant (important apres reconnexion)
                    if (APP_STATE.currentServerId && APP_STATE.currentChannelId) {
                        socket.emit('server:join', {
                            serverId: APP_STATE.currentServerId,
                            channelId: APP_STATE.currentChannelId,
                            userEmail: APP_STATE.user.email || APP_STATE.user.id
                        });
                    }
                });

                socket.on('connect_error', (error) => {
                    const errorMsg = error?.message || 'Erreur inconnue';
                    console.warn('âš ï¸ Erreur WebSocket:', errorMsg);
                    console.warn('ðŸ”´ Serveur URL:', socketUrl);
                    console.warn('ðŸ’¡ VÃ©rifiez que le serveur est en ligne!');
                    console.warn('ðŸ“ Allez sur PROBLEM_SOLUTION_SUMMARY.md pour l\'aide');
                    // Utiliser le localStorage comme fallback
                });

                socket.on('disconnect', () => {
                    console.log('âŒ DÃ©connectÃ© du serveur');
                    console.log('â³ Tentative de reconnexion...');
                });

                // Recevoir les messages en temps rÃ©el
                socket.on('message:receive', (message) => {
                    console.log('ðŸ’¬ Message reÃ§u via WebSocket:', message.content);
                    
                    // Ajouter le message au canal si le serveur et le canal existent
                    if (message.serverId && message.channelId) {
                        const server = APP_STATE.servers[message.serverId];
                        if (server && server.channels[message.channelId]) {
                            const channel = server.channels[message.channelId];
                            
                            // VÃ©rifier que le message n'existe pas dÃ©jÃ  (Ã©viter les doublons)
                            const messageExists = channel.messages.some(m => m.id === message.id);
                            if (!messageExists) {
                                channel.messages.push(message);
                            }
                            
                            // Re-rendre si c'est le canal actuel
                            if (APP_STATE.currentChannelId === message.channelId && 
                                APP_STATE.currentServerId === message.serverId) {
                                renderChatArea();
                                const chatArea = document.getElementById('messagesContainer');
                                if (chatArea) {
                                    setTimeout(() => {
                                        chatArea.scrollTop = chatArea.scrollHeight;
                                    }, 50);
                                }
                            }
                        }
                    } else if (message.channelId && APP_STATE.channels[message.channelId]) {
                        // Compatibilite ancien systeme: message sans serverId
                        const legacyChannel = APP_STATE.channels[message.channelId];
                        const messageExists = legacyChannel.messages.some(m => m.id === message.id);
                        if (!messageExists) {
                            legacyChannel.messages.push(message);
                        }

                        if (APP_STATE.currentChannel === message.channelId && !APP_STATE.currentServerId) {
                            renderMessages();
                        }
                    }

                    saveAppState();
                });

                // Recevoir les mises Ã  jour des utilisateurs en ligne
                socket.on('users:online:update', (onlineUsers) => {
                    console.log('ðŸ‘¥ Utilisateurs en ligne:', Object.keys(onlineUsers).length);
                    APP_STATE.onlineUsers = onlineUsers;
                    renderOnlineUsers();
                });

                // Recevoir les mises Ã  jour des serveurs
                socket.on('servers:update', (servers) => {
                    console.log('ðŸ“¦ Serveurs mis Ã  jour');
                    APP_STATE.servers = servers;
                    renderServerSidebar();
                });

                // Recevoir l'historique des messages
                socket.on('messages:history:response', (data) => {
                    const server = APP_STATE.servers[data.serverId];
                    if (server && server.channels[data.channelId]) {
                        server.channels[data.channelId].messages = data.messages;
                        if (APP_STATE.currentChannelId === data.channelId) {
                            renderChatArea();
                        }
                    }
                });

                // Recevoir les notifications de typage
                socket.on('user:typing', (data) => {
                    // Afficher "utilisateur est en train d'Ã©crire..."
                    if (data.isTyping) {
                        const indicator = document.getElementById('typingIndicator');
                        if (indicator) {
                            indicator.textContent = `${data.displayName} est en train d'Ã©crire...`;
                            indicator.classList.add('active');
                        }
                    } else {
                        const indicator = document.getElementById('typingIndicator');
                        if (indicator) {
                            indicator.classList.remove('active');
                        }
                    }
                });

            } catch (error) {
                console.error('Erreur WebSocket:', error);
            }
        }
        
        // Charger la session sauvegardÃ©e
        const savedSession = loadUserSession();
        if (savedSession && savedSession.email && savedSession.password) {
            const userData = APP_STATE.users[savedSession.email];
            if (userData && userData.password === savedSession.password) {
                APP_STATE.user = userData;
                APP_STATE.isLoggedIn = true;
                removeUserOnline(generateAnonymousUser().id);
                addUserOnline(userData.id);
                document.getElementById('logoutBtn').style.display = 'block';
                updateUserDisplay();
                hideWelcome();
                startRealTimeSync();
                initWebSocket();
            }
        }
        
        initApp();
        initEmojiPicker();
        setupAvatarUpload();
        startRealTimeSync();
        initWebSocket();

        // V2 Initialize sidebar SEULEMENT SI CONNECTÃ‰
        // if (APP_STATE.isLoggedIn) {
        //     renderServerSidebar();
        // }

        // V2 Event Listeners
        const createServerBtn = document.getElementById('createServerBtn');
        if (createServerBtn) {
            createServerBtn.addEventListener('click', createServerFromModal);
        }

        const cancelServerBtn = document.getElementById('cancelServerBtn');
        if (cancelServerBtn) {
            cancelServerBtn.addEventListener('click', closeServerModal);
        }

        const newServerModal = document.getElementById('newServerModal');
        if (newServerModal) {
            newServerModal.addEventListener('click', (e) => {
                if (e.target === newServerModal) {
                    closeServerModal();
                }
            });
        }
    </script>

    <!-- PAGE DE PROFIL COMPLÃˆTE -->
    <div class="profile-page" id="profilePage" style="display: none;">
        <div class="profile-page-header">
            <button class="btn-back" onclick="closeProfilePage()">â† RETOUR</button>
            <div class="profile-page-title" id="profilePageTitle">MON PROFIL</div>
            <div style="width: 80px;"></div>
        </div>

        <div class="profile-page-content">
            <!-- SECTION GAUCHE: INFOS UTILISATEUR -->
            <div class="profile-left">
                <div class="profile-avatar-section">
                    <img id="profilePageAvatar" class="profile-page-avatar" src="">
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    <button class="btn-change-avatar" id="changeAvatarBtn" onclick="changeAvatar()" style="display: none;">ðŸ“· CHANGER</button>
                </div>

                <div class="profile-user-info">
                    <div class="profile-username-edit">
                        <input type="text" class="profile-username-input" id="profileUsernameInput" placeholder="Nom d'utilisateur" style="display: none;">
                        <span class="profile-username-display" id="profileUsernameDisplay">Utilisateur</span>
                        <button class="btn-edit-username" id="editUsernameBtn" onclick="editUsername()" style="display: none;">âœï¸</button>
                    </div>
                    <div class="profile-user-id" id="profileUserIdDisplay">#0000</div>
                    <div class="profile-join-date" id="profileJoinDateDisplay">Inscrit aujourd'hui</div>
                </div>

                <!-- RANKS & BADGES -->
                <div class="profile-section">
                    <div class="profile-section-title">ðŸ… RANKS & BADGES</div>
                    <div class="profile-ranks-list" id="profileRanksList">
                        <!-- Les ranks seront affichÃ©s ici -->
                    </div>
                </div>
            </div>

            <!-- SECTION DROITE: CONTENU -->
            <div class="profile-right">
                <!-- ONGLETS -->
                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchProfileTab('favoris')">â­ FAVORIS</button>
                    <button class="profile-tab" onclick="switchProfileTab('amis')">ðŸ‘¥ AMIS</button>
                    <button class="profile-tab" onclick="switchProfileTab('serveurs')">ðŸ“¦ SERVEURS</button>
                </div>

                <!-- ONGLET FAVORIS -->
                <div class="profile-tab-content active" id="profileTab-favoris">
                    <div class="profile-section">
                        <div class="profile-section-title">â­ SERVEURS FAVORIS</div>
                        <div class="profile-favorites-list" id="profileFavoritesList">
                            <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur en favoris</div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET AMIS -->
                <div class="profile-tab-content" id="profileTab-amis">
                    <div class="profile-section">
                        <div class="profile-section-title">ðŸ‘¥ AMIS EN LIGNE</div>
                        <div class="profile-friends-list" id="profileFriendsOnlineList">
                            <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun ami en ligne</div>
                        </div>
                    </div>
                    <div class="profile-section">
                        <div class="profile-section-title">ðŸ‘¥ TOUS LES AMIS</div>
                        <div class="profile-friends-list" id="profileFriendsAllList">
                            <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun ami</div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET SERVEURS -->
                <div class="profile-tab-content" id="profileTab-serveurs">
                    <div class="profile-section">
                        <div class="profile-section-title">ðŸ“¦ MES SERVEURS</div>
                        <div class="profile-servers-list" id="profileServersList">
                            <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun serveur</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOUTONS DE MODIFICATION (si c'est mon profil) -->
        <div class="profile-actions" id="profileActions" style="display: none;">
            <button class="btn-profile-action" id="saveProfileBtn" onclick="saveProfile()">ðŸ’¾ SAUVEGARDER</button>
            <button class="btn-profile-action" id="cancelProfileBtn" onclick="cancelProfileEdit()">âŒ ANNULER</button>
        </div>
    </div>

    <!-- PAGE DE PROFIL D'AUTRES UTILISATEURS -->
    <div class="other-profile-page" id="otherProfilePage" style="display: none;">
        <div class="profile-page-header">
            <button class="btn-back" onclick="closeOtherProfilePage()">â† RETOUR</button>
            <div class="profile-page-title" id="otherProfilePageTitle">PROFIL</div>
            <div style="width: 80px;"></div>
        </div>

        <div class="profile-page-content">
            <!-- SECTION GAUCHE -->
            <div class="profile-left">
                <div class="profile-avatar-section">
                    <img id="otherProfileAvatar" class="profile-page-avatar" src="">
                </div>

                <div class="profile-user-info">
                    <div class="profile-username-display" id="otherProfileUsername">Utilisateur</div>
                    <div class="profile-user-id" id="otherProfileUserId">#0000</div>
                    <div class="profile-join-date" id="otherProfileJoinDate">Inscrit aujourd'hui</div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">ðŸ… RANKS & BADGES</div>
                    <div class="profile-ranks-list" id="otherProfileRanksList"></div>
                </div>
            </div>

            <!-- SECTION DROITE -->
            <div class="profile-right">
                <div class="profile-other-actions">
                    <button class="btn-profile-action primary" id="contactBtn" onclick="contactUser()">ðŸ’¬ CONTACTER</button>
                    <button class="btn-profile-action secondary" id="addFriendBtn" onclick="addCurrentUserFriend()">âž• AJOUTER EN AMI</button>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">ðŸ“¦ SERVEURS</div>
                    <div class="profile-servers-list" id="otherProfileServersList"></div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">ðŸ‘¥ AMIS</div>
                    <div class="profile-friends-list" id="otherProfileFriendsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE DE DISCUSSION PRIVÃ‰E COMPLÃˆTE -->
    <div class="dm-page" id="dmPage" style="display: none;">
        <div class="dm-page-header">
            <button class="btn-back" onclick="closeDMPage()">â† RETOUR</button>
            <div class="dm-page-title" id="dmPageTitle">MESSAGES DIRECTS</div>
            <div style="width: 80px;"></div>
        </div>

        <div class="dm-page-container">
            <!-- LISTE DES CONVERSATIONS -->
            <div class="dm-sidebar">
                <div class="dm-sidebar-title">CONVERSATIONS</div>
                <input type="text" class="dm-search" id="dmSearch" placeholder="Chercher un ami...">
                
                <div class="dm-conversations-list" id="dmConversationsList">
                    <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucune conversation</div>
                </div>

                <div class="dm-sidebar-title" style="margin-top: 24px;">AMIS</div>
                <div class="dm-friends-list" id="dmFriendsList">
                    <div style="text-align: center; color: var(--color-text-dim); padding: 20px;">Aucun ami</div>
                </div>
            </div>

            <!-- ZONE DE CHAT -->
            <div class="dm-chat">
                <div class="dm-chat-header" id="dmChatHeader">
                    <div class="dm-chat-title" id="dmChatTitle">SÃ©lectionnez une conversation</div>
                    <div class="dm-chat-status" id="dmChatStatus"></div>
                </div>

                <div class="dm-messages-container" id="dmMessagesContainer">
                    <div style="text-align: center; color: var(--color-text-dim); padding: 40px;">
                        SÃ©lectionnez une conversation pour commencer Ã  discuter
                    </div>
                </div>

                <div class="dm-input-area">
                    <input type="text" class="dm-message-input" id="dmMessageInput" placeholder="Ã‰crivez votre message...">
                    <button class="dm-send-btn" id="dmSendBtn" onclick="sendDMMessage()">ENVOYER</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


